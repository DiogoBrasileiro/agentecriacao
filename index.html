<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SQUAD ‚Äî Instagram Card Creator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { height: 100%; }
body {
  background: #0c0c0c; color: #f0f0f0;
  font-family: 'Inter', system-ui, sans-serif;
  min-height: 100%; overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* HEADER */
.hdr {
  position: sticky; top: 0; z-index: 100;
  background: rgba(12,12,12,.97); backdrop-filter: blur(12px);
  border-bottom: 1px solid #222;
  padding: 12px 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.logo { font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 5px; }
.logo b { color: #ff3c00; font-weight: 400; }
.badge-live {
  font-family: 'Space Mono'; font-size: 9px; color: #22c55e;
  border: 1px solid rgba(34,197,94,.35); border-radius: 20px;
  padding: 4px 10px; display: flex; align-items: center; gap: 5px;
}
.badge-live::before {
  content: ''; width: 5px; height: 5px; border-radius: 50%;
  background: #22c55e; animation: blink 2s infinite; flex-shrink: 0;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.15} }

/* PAGE */
.page { padding: 14px 14px 80px; max-width: 520px; margin: 0 auto; }

/* BOX CARD */
.box {
  background: #161616; border: 1px solid #242424;
  border-radius: 14px; padding: 16px; margin-bottom: 10px;
}
.box-title {
  font-family: 'Space Mono'; font-size: 9px; letter-spacing: 2px;
  color: #ff3c00; text-transform: uppercase; margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.box-title::after { content: ''; flex: 1; height: 1px; background: #242424; }

/* KEY BOX */
.key-status {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 13px; border-radius: 10px; margin-bottom: 10px;
  font-size: 13px; font-family: 'Space Mono';
}
.key-status.has-key {
  background: #071a0e; border: 1px solid rgba(34,197,94,.3);
  color: #22c55e;
}
.key-status.no-key {
  background: #1a1a1a; border: 1px solid #2a2a2a;
  color: #666;
}
.key-row { display: flex; gap: 8px; }
.key-inp {
  flex: 1; min-width: 0;
  background: #1a1a1a; border: 1px solid #2a2a2a; color: #f0f0f0;
  padding: 11px 12px; border-radius: 10px;
  font-family: 'Space Mono'; font-size: 12px; outline: none;
  transition: border-color .2s;
}
.key-inp:focus { border-color: #38bdf8; }
.key-btn {
  background: #38bdf8; color: #000; border: none;
  padding: 11px 16px; border-radius: 10px;
  font-weight: 700; font-size: 14px; cursor: pointer;
  white-space: nowrap; flex-shrink: 0;
}
.key-btn:active { opacity: .8; }
.key-clear {
  background: #1a1a1a; border: 1px solid #2a2a2a; color: #666;
  padding: 11px 14px; border-radius: 10px;
  font-size: 13px; cursor: pointer; flex-shrink: 0;
}
.key-hint { font-size: 12px; color: #555; margin-top: 8px; line-height: 1.6; }
.key-hint a { color: #38bdf8; text-decoration: none; }

/* FORM FIELDS */
.f { margin-bottom: 11px; }
.f:last-child { margin-bottom: 0; }
.f label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; letter-spacing: .3px; }
.inp, .sel, .ta {
  display: block; width: 100%;
  background: #1a1a1a; border: 1px solid #2a2a2a; color: #f0f0f0;
  padding: 12px 14px; border-radius: 10px;
  font-family: 'Inter'; font-size: 15px; outline: none;
  transition: border-color .2s; appearance: none; -webkit-appearance: none;
}
.inp:focus, .sel:focus, .ta:focus { border-color: #ff3c00; }
.sel-w { position: relative; }
.sel-w::after {
  content: '‚ñæ'; position: absolute; right: 14px; top: 50%;
  transform: translateY(-50%); color: #555;
  pointer-events: none; font-size: 14px;
}
.sel { padding-right: 36px; }
.sel option { background: #1a1a1a; }
.ta { resize: vertical; min-height: 80px; line-height: 1.5; }

/* FORMAT */
.fmt-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.fmt-opt {
  background: #1a1a1a; border: 1.5px solid #2a2a2a;
  border-radius: 12px; padding: 12px 6px; cursor: pointer;
  text-align: center; display: flex; flex-direction: column; align-items: center; gap: 6px;
  transition: border-color .15s, background .15s;
}
.fmt-opt.on { border-color: #ff3c00; background: rgba(255,60,0,.08); }
.fmt-thumb { background: #2a2a2a; border: 1.5px solid #383838; border-radius: 3px; }
.fmt-opt.on .fmt-thumb { border-color: #ff3c00; }
.fmt-name { font-family: 'Bebas Neue'; font-size: 13px; letter-spacing: 1px; color: #666; }
.fmt-size { font-family: 'Space Mono'; font-size: 8px; color: #444; }
.fmt-opt.on .fmt-name { color: #ff3c00; }

/* BIG BUTTONS */
.btn-go {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 17px; margin-bottom: 10px;
  background: #ff3c00; color: #fff; border: none; border-radius: 14px;
  font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 4px;
  cursor: pointer; transition: opacity .15s, transform .1s;
}
.btn-go:active { opacity: .85; transform: scale(.98); }
.btn-go:disabled { background: #222; color: #444; cursor: not-allowed; transform: none; opacity: 1; }

.btn-arte {
  display: none; width: 100%; align-items: center; justify-content: center; gap: 8px;
  padding: 17px; margin-bottom: 10px;
  background: linear-gradient(135deg, #7c3aed, #a855f7);
  color: #fff; border: none; border-radius: 14px;
  font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 3px;
  cursor: pointer; transition: opacity .15s, transform .1s;
}
.btn-arte.show { display: flex; }
.btn-arte:active { opacity: .85; transform: scale(.98); }
.btn-arte:disabled { background: #222; color: #444; cursor: not-allowed; transform: none; opacity: 1; }

/* PROGRESS */
.prog-wrap { display: none; margin-bottom: 10px; }
.prog-wrap.show { display: block; }
.prog-track { height: 3px; background: #1e1e1e; border-radius: 2px; overflow: hidden; margin-bottom: 7px; }
.prog-fill { height: 100%; background: linear-gradient(90deg, #ff3c00, #ffcc00); width: 0%; transition: width .5s; }
.prog-info { font-family: 'Space Mono'; font-size: 10px; color: #555; display: flex; justify-content: space-between; }

/* AGENTS */
.agent-card {
  background: #161616; border: 1px solid #242424;
  border-radius: 12px; margin-bottom: 8px; overflow: hidden;
  transition: border-color .25s;
}
.agent-card.running { border-color: #ff3c00; }
.agent-card.done { border-color: rgba(34,197,94,.4); }
.agent-card.error { border-color: rgba(239,68,68,.4); }

.agent-hd {
  display: flex; align-items: center; gap: 12px; padding: 14px;
  cursor: pointer; user-select: none;
}
.agent-ico {
  width: 42px; height: 42px; flex-shrink: 0;
  background: #1e1e1e; border: 1px solid #2a2a2a; border-radius: 11px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; transition: .2s;
}
.agent-card.running .agent-ico { background: rgba(255,60,0,.12); border-color: #ff3c00; }
.agent-card.done    .agent-ico { background: rgba(34,197,94,.1);  border-color: rgba(34,197,94,.4); }
.agent-card.error   .agent-ico { background: rgba(239,68,68,.1);  border-color: rgba(239,68,68,.4); }

.agent-meta { flex: 1; min-width: 0; }
.agent-num  { font-family: 'Space Mono'; font-size: 9px; color: #444; }
.agent-name { font-family: 'Bebas Neue'; font-size: 17px; letter-spacing: 1px; line-height: 1.1; }
.agent-role { font-size: 11px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.agent-tag {
  font-family: 'Space Mono'; font-size: 9px;
  padding: 4px 8px; border-radius: 20px;
  border: 1px solid #2a2a2a; color: #444; flex-shrink: 0;
}
.agent-card.running .agent-tag { border-color: #ff3c00; color: #ff3c00; }
.agent-card.done    .agent-tag { border-color: #22c55e; color: #22c55e; }
.agent-card.error   .agent-tag { border-color: #ef4444; color: #ef4444; }

.agent-body { display: none; padding: 0 14px 14px; border-top: 1px solid #1e1e1e; }
.agent-body.open { display: block; padding-top: 12px; }
.agent-text {
  font-size: 12px; line-height: 1.8; color: #999;
  white-space: pre-wrap; word-break: break-word;
}
.agent-text strong { color: #ffcc00; }
.agent-text .err-txt { color: #ff8060; }

/* DOTS LOADER */
.dots { display: flex; gap: 4px; padding: 8px 0; }
.dots span {
  width: 5px; height: 5px; border-radius: 50%;
  background: #ff3c00; animation: dotbounce 1.2s infinite;
}
.dots span:nth-child(2) { animation-delay: .2s; }
.dots span:nth-child(3) { animation-delay: .4s; }
@keyframes dotbounce { 0%,100%{opacity:.2;transform:translateY(0)} 50%{opacity:1;transform:translateY(-5px)} }

/* OUTPUT BOXES */
.prompt-box {
  background: #050e0a; border: 1px solid rgba(34,197,94,.2);
  border-radius: 12px; padding: 14px; margin-bottom: 8px; display: none;
}
.prompt-box.show { display: block; }
.prompt-box-lbl { font-family: 'Space Mono'; font-size: 9px; color: #22c55e; letter-spacing: 2px; margin-bottom: 8px; }
.prompt-box-txt {
  font-family: 'Space Mono'; font-size: 11px; color: #5ef0a0;
  line-height: 1.6; word-break: break-all; white-space: pre-wrap;
}

.leg-box {
  background: #161616; border: 1px solid rgba(255,204,0,.25);
  border-radius: 12px; padding: 14px; margin-bottom: 8px; display: none;
}
.leg-box.show { display: block; }
.leg-box-lbl { font-family: 'Space Mono'; font-size: 9px; color: #ffcc00; letter-spacing: 2px; margin-bottom: 8px; }
.leg-box-txt { font-size: 13px; line-height: 1.85; color: #ddd; white-space: pre-wrap; word-break: break-word; }

.collapsible {
  background: #161616; border: 1px solid #242424;
  border-radius: 12px; margin-bottom: 8px; overflow: hidden;
}
.coll-hd {
  padding: 13px 14px; display: flex; align-items: center;
  justify-content: space-between; cursor: pointer;
}
.coll-hd:active { background: #1e1e1e; }
.coll-title { font-family: 'Bebas Neue'; font-size: 14px; letter-spacing: 1px; }
.coll-body {
  display: none; padding: 0 14px 14px;
  font-size: 12px; line-height: 1.8; color: #999;
  white-space: pre-wrap; word-break: break-word;
  border-top: 1px solid #1e1e1e;
}
.coll-body.open { display: block; padding-top: 12px; }
.coll-body strong { color: #ffcc00; }

/* COPY BTN */
.copy-btn {
  display: inline-flex; align-items: center; gap: 5px;
  margin-top: 10px; background: #1e1e1e;
  border: 1px solid #2a2a2a; color: #666;
  padding: 7px 13px; border-radius: 8px;
  font-size: 12px; cursor: pointer;
}
.copy-btn:active { background: #2a2a2a; }

/* MODAL */
.modal {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,.92); backdrop-filter: blur(10px);
  display: none; flex-direction: column;
  overflow-y: auto; -webkit-overflow-scrolling: touch;
  padding: 14px 14px 60px;
}
.modal.open { display: flex; }
.modal-box {
  background: #111; border: 1px solid #2a2a2a; border-radius: 18px;
  overflow: hidden; width: 100%; max-width: 520px; margin: auto;
}
.modal-hd {
  padding: 15px 16px; border-bottom: 1px solid #1e1e1e;
  display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 2px; }
.modal-title em { color: #a855f7; font-style: normal; }
.modal-close {
  width: 32px; height: 32px; border-radius: 9px;
  border: 1px solid #2a2a2a; background: transparent;
  color: #666; font-size: 18px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.modal-content { padding: 16px; display: flex; flex-direction: column; gap: 14px; align-items: center; }

.steps-list { width: 100%; background: #1a1a1a; border-radius: 10px; padding: 10px 12px; }
.step-item { font-family: 'Space Mono'; font-size: 10px; color: #444; padding: 3px 0; display: flex; align-items: center; gap: 7px; }
.step-item.active { color: #ffcc00; }
.step-item.ok  { color: #22c55e; }
.step-item.err { color: #ef4444; }

.card-preview-wrap { width: 100%; position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,.8); }
.card-preview-ratio { width: 100%; position: relative; }
.card-preview-inner { position: absolute; inset: 0; overflow: hidden; }

.preview-spinner {
  position: absolute; inset: 0;
  background: rgba(0,0,0,.85);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 12px; z-index: 5; border-radius: 12px;
}
.preview-spinner.hidden { display: none; }
.spin-ring {
  width: 40px; height: 40px; border-radius: 50%;
  border: 3px solid #2a2a2a; border-top-color: #a855f7;
  animation: spinring .9s linear infinite;
}
@keyframes spinring { to { transform: rotate(360deg); } }
.spin-txt { font-family: 'Space Mono'; font-size: 10px; color: #a855f7; letter-spacing: 1px; text-align: center; }

.modal-status { font-family: 'Space Mono'; font-size: 11px; color: #555; text-align: center; width: 100%; }
.modal-status.ok  { color: #22c55e; }
.modal-status.err { color: #ef4444; }

.btn-download {
  width: 100%; padding: 16px;
  background: linear-gradient(135deg, #6d28d9, #a855f7);
  color: #fff; border: none; border-radius: 14px;
  font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 3px;
  cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: opacity .15s;
}
.btn-download:active { opacity: .85; }
.btn-download:disabled { background: #222; color: #444; cursor: not-allowed; opacity: 1; }

/* HIDDEN RENDER */
#RENDER_TARGET {
  position: fixed; left: -19999px; top: 0;
  z-index: -1; overflow: hidden; pointer-events: none;
}

/* TOAST */
.toast {
  position: fixed; bottom: 22px; left: 50%; transform: translateX(-50%);
  background: #1e1e1e; color: #f0f0f0;
  padding: 11px 20px; border-radius: 20px;
  font-size: 13px; z-index: 9999;
  border: 1px solid #333; pointer-events: none;
  white-space: nowrap; max-width: 90vw;
  animation: toastanim .2s ease;
}
@keyframes toastanim { from { opacity:0; transform: translate(-50%,8px); } to { opacity:1; transform:translateX(-50%); } }
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <div class="logo">SQU<b>AD</b></div>
  <div class="badge-live" id="modelBadge">GEMINI AUTO</div>
</div>

<div class="page">

  <!-- API KEY -->
  <div class="box">
    <div class="box-title">// Gemini API Key</div>
    <div class="key-status no-key" id="keyStatus">
      <span id="keyStatusIcon">‚óã</span>
      <span id="keyStatusMsg">Nenhuma key configurada</span>
    </div>
    <div class="key-row">
      <input class="key-inp" id="keyInput" type="password" placeholder="Cole aqui sua key do Google AI Studio (AIza...)"/>
      <button class="key-btn" onclick="SQUAD.saveKey()">Salvar</button>
      <button class="key-clear" id="keyClear" onclick="SQUAD.clearKey()" style="display:none">‚úï</button>
    </div>
    <div class="key-hint">
      Gr√°tis em <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a><br>
      <span style="color:#22c55e">‚úì Key salva no navegador ‚Äî n√£o precisa informar toda vez.</span>
    </div>
  </div>

  <!-- BRIEF -->
  <div class="box">
    <div class="box-title">// Brief Criativo</div>
    <div class="f">
      <label>Marca / Cliente</label>
      <input class="inp" id="fBrand" type="text" placeholder="Ex: Studio Fit, Caf√© Noir..."/>
    </div>
    <div class="f">
      <label>Nicho</label>
      <div class="sel-w">
        <select class="sel" id="fNiche">
          <option value="">Selecione...</option>
          <option>Moda e Lifestyle</option>
          <option>Food e Gastronomia</option>
          <option>Saude e Fitness</option>
          <option>Negocios e Empreendedorismo</option>
          <option>E-commerce e Produto</option>
          <option>Beleza e Estetica</option>
          <option>Tech e Startups</option>
          <option>Imoveis</option>
          <option>Educacao e Cursos</option>
          <option>Financas e Investimentos</option>
        </select>
      </div>
    </div>
    <div class="f">
      <label>Objetivo</label>
      <div class="sel-w">
        <select class="sel" id="fObj">
          <option value="">Selecione...</option>
          <option>Engajamento maximo</option>
          <option>Conversao e Vendas</option>
          <option>Awareness e Branding</option>
          <option>Lancamento de produto</option>
          <option>Autoridade e Educacao</option>
          <option>Oferta e Promocao</option>
        </select>
      </div>
    </div>
    <div class="f">
      <label>Produto / Servi√ßo / Tema *</label>
      <textarea class="ta" id="fDesc" placeholder="Descreva o que ser√° comunicado: produto, servi√ßo, oferta, diferencial, p√∫blico..."></textarea>
    </div>
    <div class="f">
      <label>Tom Visual</label>
      <div class="sel-w">
        <select class="sel" id="fTone">
          <option value="">Selecione...</option>
          <option>Premium e Luxo</option>
          <option>Moderno e Bold</option>
          <option>Inspirador e Emocional</option>
          <option>Divertido e Jovem</option>
          <option>Clean e Organico</option>
          <option>Dark e Cinematografico</option>
          <option>Corporativo e Profissional</option>
        </select>
      </div>
    </div>
    <div class="f">
      <label>P√∫blico-Alvo (opcional)</label>
      <input class="inp" id="fAud" type="text" placeholder="Ex: Mulheres 28-42, classe B..."/>
    </div>
  </div>

  <!-- FORMAT -->
  <div class="box">
    <div class="box-title">// Formato do Card</div>
    <div class="fmt-grid">
      <div class="fmt-opt on" id="fmt0" onclick="SQUAD.selFmt(0,1080,1080,'Feed 1:1')">
        <div class="fmt-thumb" style="width:34px;height:34px"></div>
        <div class="fmt-name">FEED</div>
        <div class="fmt-size">1080√ó1080</div>
      </div>
      <div class="fmt-opt" id="fmt1" onclick="SQUAD.selFmt(1,1080,1350,'Portrait 4:5')">
        <div class="fmt-thumb" style="width:26px;height:34px"></div>
        <div class="fmt-name">PORTRAIT</div>
        <div class="fmt-size">1080√ó1350</div>
      </div>
      <div class="fmt-opt" id="fmt2" onclick="SQUAD.selFmt(2,1080,1920,'Stories 9:16')">
        <div class="fmt-thumb" style="width:18px;height:34px"></div>
        <div class="fmt-name">STORIES</div>
        <div class="fmt-size">1080√ó1920</div>
      </div>
    </div>
  </div>

  <!-- LAUNCH -->
  <button class="btn-go" id="btnGo" onclick="SQUAD.launch()">‚ñ∂ ACIONAR SQUAD</button>

  <!-- PROGRESS -->
  <div class="prog-wrap" id="progWrap">
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-info">
      <span id="progLabel">Iniciando...</span>
      <span id="progPct">0%</span>
    </div>
  </div>

  <!-- AGENTS -->
  <div id="agentList"></div>

  <!-- PROMPT OUTPUT -->
  <div class="prompt-box" id="promptBox">
    <div class="prompt-box-lbl">PROMPT ‚Äî MIDJOURNEY / POLLINATIONS AI</div>
    <div class="prompt-box-txt" id="promptTxt"></div>
    <button class="copy-btn" onclick="SQUAD.copyEl('promptTxt',this)">‚éò Copiar prompt</button>
  </div>

  <!-- LEGENDA OUTPUT -->
  <div class="leg-box" id="legendaBox">
    <div class="leg-box-lbl">LEGENDA INSTAGRAM</div>
    <div class="leg-box-txt" id="legendaTxt"></div>
    <button class="copy-btn" onclick="SQUAD.copyEl('legendaTxt',this)">‚éò Copiar legenda</button>
  </div>

  <!-- EXTRA COLLAPSIBLE OUTPUTS -->
  <div id="extraOutputs"></div>

  <!-- ARTE FINAL -->
  <button class="btn-arte" id="btnArte" onclick="SQUAD.openModal()">üé® GERAR ARTE FINAL</button>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">ARTE <em>FINAL</em></div>
      <button class="modal-close" onclick="SQUAD.closeModal()">‚úï</button>
    </div>
    <div class="modal-content">
      <div class="steps-list" id="stepsList"></div>
      <div class="modal-status" id="modalStatus">Aguardando...</div>
      <div class="card-preview-wrap" id="previewWrap">
        <div class="preview-spinner" id="previewSpinner">
          <div class="spin-ring"></div>
          <div class="spin-txt" id="spinTxt">GERANDO IMAGEM...</div>
        </div>
        <div class="card-preview-ratio" id="previewRatio">
          <div class="card-preview-inner" id="previewInner"></div>
        </div>
      </div>
      <button class="btn-download" id="btnDownload" onclick="SQUAD.download()" disabled>‚¨á BAIXAR PNG</button>
    </div>
  </div>
</div>

<!-- HIDDEN FULL-RES RENDER TARGET -->
<div id="RENDER_TARGET"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SQUAD ‚Äî All functions on global SQUAD object
// No IIFE wrapper ‚Äî prevents scope issues with onclick
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var SQUAD = {};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _key    = '';
var _brief  = {};
var _outs   = [];
var _fmt    = { w:1080, h:1080, label:'Feed 1:1' };
var _busy   = false;
var _mj     = '';
var _artSteps = [];

var LS_KEY = 'squad_gkey_v1';

// ‚îÄ‚îÄ localStorage PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SQUAD.loadKey = function() {
  try {
    var k = localStorage.getItem(LS_KEY) || '';
    if (k && k.length > 10) {
      _key = k;
      _updateKeyUI(true);
    }
  } catch(e) {}
};

SQUAD.saveKey = function() {
  var inp = document.getElementById('keyInput');
  var v = (inp.value || '').trim();
  if (!v) { SQUAD.toast('‚ö† Cole a API Key primeiro!'); inp.focus(); return; }
  if (!v.startsWith('AIza')) {
    inp.style.borderColor = '#ef4444';
    setTimeout(function(){ inp.style.borderColor = ''; }, 2000);
    SQUAD.toast('‚ö† Key inv√°lida ‚Äî deve come√ßar com AIza');
    return;
  }
  _key = v;
  try { localStorage.setItem(LS_KEY, v); } catch(e) {}
  inp.value = '';
  _updateKeyUI(true);
  SQUAD.toast('‚úì Key salva no navegador!');
};

SQUAD.clearKey = function() {
  _key = '';
  try { localStorage.removeItem(LS_KEY); } catch(e) {}
  _updateKeyUI(false);
  SQUAD.toast('Key removida');
};

function _updateKeyUI(has) {
  var st = document.getElementById('keyStatus');
  var icon = document.getElementById('keyStatusIcon');
  var msg  = document.getElementById('keyStatusMsg');
  var clrBtn = document.getElementById('keyClear');
  if (has) {
    st.className = 'key-status has-key';
    icon.textContent = '‚úì';
    msg.textContent = 'Key ativa: ' + _key.substring(0,12) + '...';
    clrBtn.style.display = 'block';
  } else {
    st.className = 'key-status no-key';
    icon.textContent = '‚óã';
    msg.textContent = 'Nenhuma key configurada';
    clrBtn.style.display = 'none';
  }
}

// ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SQUAD.selFmt = function(idx, w, h, label) {
  [0,1,2].forEach(function(i){ document.getElementById('fmt'+i).classList.remove('on'); });
  document.getElementById('fmt'+idx).classList.add('on');
  _fmt = { w:w, h:h, label:label };
};

// ‚îÄ‚îÄ AGENTS DEFINITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _agents = [
  {
    ico:'üß†', name:'ESTRATEGISTA', role:'Insight, conceito e arquitetura do post',
    prompt: function() {
      return 'Voc√™ √© Estrategista de Conte√∫do S√™nior especializado em Instagram.\n'
        + 'Responda em portugu√™s brasileiro. Use **negrito** nos t√≠tulos.\n\n'
        + 'BRIEF DO CLIENTE:\n'
        + 'Marca: ' + _brief.brand + '\n'
        + 'Nicho: ' + _brief.niche + '\n'
        + 'Objetivo: ' + _brief.obj + '\n'
        + 'Produto/Tema: ' + _brief.desc + '\n'
        + 'Tom: ' + _brief.tone + '\n'
        + 'P√∫blico: ' + (_brief.aud || 'Deduzir pelo nicho') + '\n'
        + 'Formato: ' + _fmt.label + ' (' + _fmt.w + '√ó' + _fmt.h + 'px)\n\n'
        + '**DIAGN√ìSTICO DO P√öBLICO**\n'
        + 'Quem √©, qual dor, o que deseja, como se comporta no Instagram.\n\n'
        + '**INSIGHT ESTRAT√âGICO**\n'
        + 'A descoberta n√£o-√≥bvia que fundamenta este post.\n\n'
        + '**√ÇNGULO CRIATIVO**\n'
        + 'Por que este √¢ngulo vai funcionar para este objetivo.\n\n'
        + '**GANCHO CENTRAL**\n'
        + 'Uma frase que para o scroll.\n\n'
        + '**ELEMENTOS DO CARD**\n'
        + 'Badge, headline, subt√≠tulo, CTA, elemento visual de destaque.\n\n'
        + '**KPIs DE SUCESSO**\n'
        + 'M√©tricas que indicam que o post performou.';
    }
  },
  {
    ico:'‚úçÔ∏è', name:'COPYWRITER', role:'Textos definitivos que entram no card visual',
    prompt: function() {
      return 'Voc√™ √© Copywriter S√™nior de resposta direta para Instagram.\n'
        + 'No Instagram o texto do card tem 0,3 a 2 segundos para funcionar.\n'
        + 'Responda em portugu√™s brasileiro.\n\n'
        + 'ESTRAT√âGIA DO AGENTE ANTERIOR:\n'
        + (_outs[0] || 'N/A').substring(0, 500) + '\n\n'
        + 'Marca: ' + _brief.brand + ' | Tom: ' + _brief.tone + '\n\n'
        + 'RETORNE EXATAMENTE NESTE FORMATO:\n\n'
        + '**BADGE**\n'
        + '[2-3 palavras MAI√öSCULO. Ex: NOVO, EXCLUSIVO. Deixe vazio se n√£o fizer sentido]\n\n'
        + '**EYEBROW**\n'
        + '[linha acima do headline, m√°x 5 palavras]\n\n'
        + '**HEADLINE**\n'
        + '[MAI√öSCULO, m√°x 5 palavras, irresist√≠vel]\n\n'
        + '**SUBTEXT**\n'
        + '[complemento, m√°x 12 palavras]\n\n'
        + '**CTA**\n'
        + '[chamada √† a√ß√£o, m√°x 4 palavras]\n\n'
        + '**JUSTIFICATIVA**\n'
        + '[Por que estas escolhas funcionam]';
    }
  },
  {
    ico:'üì∏', name:'DIR. FOTOGRAFIA', role:'Prompt de imagem para Pollinations / Midjourney',
    prompt: function() {
      return 'Voc√™ √© Diretor de Fotografia especializado em prompts para IA generativa.\n'
        + 'A imagem de fundo do card precisa: impacto visual + √°rea inferior mais limpa para texto.\n'
        + 'Responda em portugu√™s. O PROMPT DE IMAGEM deve ser em ingl√™s.\n\n'
        + 'Nicho: ' + _brief.niche + ' | Tom: ' + _brief.tone + '\n'
        + 'Formato: ' + _fmt.w + '√ó' + _fmt.h + 'px\n'
        + 'Copy do card: ' + (_outs[1] || 'N/A').substring(0, 200) + '\n\n'
        + '**CONCEITO DA IMAGEM**\n'
        + 'O que vai mostrar e por que √© poderoso para este post.\n\n'
        + '**ESTILO FOTOGR√ÅFICO**\n'
        + 'Fotografia real, CGI, abstrato? Qual refer√™ncia.\n\n'
        + '**PROMPT DE IMAGEM**\n'
        + '[Prompt completo EM INGL√äS: sujeito, ambiente, ilumina√ß√£o, mood, estilo, qualidade. '
        + '√Årea inferior da imagem deve ter menos elementos. '
        + 'Finalizar com: professional photography, 8k resolution, cinematic lighting, no text, no watermark]\n\n'
        + '**TRATAMENTO DE COR**\n'
        + 'Paleta e grading de como conversa com o design.';
    }
  },
  {
    ico:'üé®', name:'DIR. DE ARTE', role:'Paleta HEX, fontes, composi√ß√£o e JSON do card',
    prompt: function() {
      return 'Voc√™ √© Diretor de Arte S√™nior para Instagram de marcas globais.\n'
        + 'Retorne um CARD_JSON com cores HEX exatas para renderiza√ß√£o CSS.\n'
        + 'Responda em portugu√™s.\n\n'
        + 'Nicho: ' + _brief.niche + ' | Tom: ' + _brief.tone + '\n'
        + 'Formato: ' + _fmt.w + '√ó' + _fmt.h + 'px\n'
        + 'Copy: ' + (_outs[1] || 'N/A').substring(0, 300) + '\n\n'
        + '**CONCEITO VISUAL**\n'
        + 'Escola de design e o que o layout comunica.\n\n'
        + '**PALETA DE CORES** (HEX obrigat√≥rio para cada cor)\n'
        + 'Justifique cada escolha.\n\n'
        + '**TIPOGRAFIA**\n'
        + 'Fontes Google Fonts espec√≠ficas com peso.\n\n'
        + 'RETORNE ESTE JSON NO FINAL (preencha com HEX reais ‚Äî sem placeholders):\n'
        + 'CARD_JSON_START\n'
        + '{"bg1":"#0a0a0a","bg2":"#1a1a2e","overlay":"rgba(0,0,0,0.65)",'
        + '"hlColor":"#FFFFFF","hlFont":"Bebas Neue","hlSize":' + (_fmt.h > 1500 ? 110 : _fmt.h > 1100 ? 88 : 72) + ','
        + '"eyColor":"#FFCC00","eyFont":"Space Mono",'
        + '"stColor":"rgba(255,255,255,0.80)","stFont":"Inter",'
        + '"badgeBg":"#FF3C00","badgeFg":"#FFFFFF","ctaColor":"#FFFFFF",'
        + '"acc1":"#FF3C00","acc2":"#FFCC00","decor":"rgba(255,255,255,0.04)"}\n'
        + 'CARD_JSON_END';
    }
  },
  {
    ico:'üí¨', name:'COPY LEGENDA', role:'Legenda poderosa + hashtags estrat√©gicas',
    prompt: function() {
      return 'Voc√™ √© especialista em Copy de legenda para Instagram que gera engajamento real.\n'
        + 'A legenda aprofunda o card ‚Äî n√£o repete o que est√° nele.\n'
        + 'Responda em portugu√™s brasileiro.\n\n'
        + 'Marca: ' + _brief.brand + ' | Objetivo: ' + _brief.obj + ' | Tom: ' + _brief.tone + '\n'
        + 'O que est√° no card (n√£o repita): ' + (_outs[1] || 'N/A').substring(0, 200) + '\n\n'
        + '**HOOK** (primeira linha antes do "ver mais" ‚Äî m√°x 125 chars ‚Äî CR√çTICO)\n'
        + '[Provocador, curioso ou promessa forte]\n\n'
        + '**CORPO**\n'
        + '[4-5 par√°grafos curtos com emojis. Storytelling, benef√≠cios ou autoridade.]\n\n'
        + '**CTA PRINCIPAL**\n'
        + '[A√ß√£o espec√≠fica]\n\n'
        + '**CTA SECUND√ÅRIO**\n'
        + '[Salvar, marcar algu√©m, compartilhar]\n\n'
        + '**HASHTAGS**\n'
        + '[25 hashtags: 5 mega + 8 grandes + 8 m√©dias + 4 nicho]\n\n'
        + '**MELHOR HOR√ÅRIO**\n'
        + '[Dia + hora + justificativa]';
    }
  },
  {
    ico:'üìä', name:'TR√ÅFEGO PAGO', role:'Meta Ads: copy, segmenta√ß√£o e estrat√©gia',
    prompt: function() {
      return 'Voc√™ √© Especialista em Meta Ads com 10 anos de experi√™ncia gerindo campanhas.\n'
        + 'Responda em portugu√™s brasileiro.\n\n'
        + 'Objetivo: ' + _brief.obj + ' | Nicho: ' + _brief.niche + ' | Formato: ' + _fmt.label + '\n'
        + 'Copy do card: ' + (_outs[1] || 'N/A').substring(0, 200) + '\n\n'
        + '**COPY PARA AN√öNCIO**\n'
        + 'Texto principal (m√°x 125 chars): |\n'
        + 'Headline (m√°x 40 chars): |\n'
        + 'Descri√ß√£o (m√°x 30 chars):\n\n'
        + '**OBJETIVO META ADS**\n'
        + '[Qual usar e por qu√™]\n\n'
        + '**SEGMENTA√á√ÉO PRIM√ÅRIA**\n'
        + 'Interesses + comportamentos + demografia\n\n'
        + '**ESTRUTURA DE CAMPANHA**\n'
        + 'Or√ßamento di√°rio sugerido + dura√ß√£o do teste\n\n'
        + '**TESTE A/B**\n'
        + 'Varia√ß√£o A: | Varia√ß√£o B: | Crit√©rio de vencedor:\n\n'
        + '**M√âTRICAS ESPERADAS**\n'
        + 'CTR: | CPM: | CPC: | ROAS m√≠nimo:';
    }
  },
  {
    ico:'üèÜ', name:'DIR. CRIATIVO', role:'Revis√£o final e checklist de publica√ß√£o',
    prompt: function() {
      return 'Voc√™ √© o Diretor Criativo Executivo da ag√™ncia ‚Äî o olhar mais exigente.\n'
        + 'Sua revis√£o √© cir√∫rgica, honesta e construtiva. Nunca valida por validar.\n'
        + 'Responda em portugu√™s brasileiro.\n\n'
        + 'Marca: ' + _brief.brand + ' | Objetivo: ' + _brief.obj + '\n'
        + 'Copy do card: ' + (_outs[1] || 'N/A').substring(0, 150) + '\n'
        + 'Legenda: ' + (_outs[4] || 'N/A').substring(0, 150) + '\n\n'
        + '**AVALIA√á√ÉO** (nota 0-10 com diagn√≥stico)\n'
        + 'Estrat√©gia: /10 | Copy: /10 | Arte: /10 | Foto: /10 | Legenda: /10 | Tr√°fego: /10\n\n'
        + '**COER√äNCIA**\n'
        + 'Card e legenda se complementam? Tom consistente?\n\n'
        + '**PONTOS FORTES**\n\n'
        + '**AJUSTES CR√çTICOS** (m√°x 3)\n\n'
        + '**CHECKLIST DE PUBLICA√á√ÉO**\n'
        + '- [ ] Revis√£o ortogr√°fica\n'
        + '- [ ] Links testados\n'
        + '- [ ] Resolu√ß√£o correta\n'
        + '- [ ] CTA claro\n'
        + '- [ ] Hashtags verificadas\n'
        + '- [ ] Hor√°rio definido\n'
        + '- [ ] Pixel e UTMs configurados\n\n'
        + '**SCORE FINAL**\n'
        + 'Nota: /10 | Performance acima da m√©dia: %\n'
        + 'Veredicto: APROVADO / COM AJUSTES / REFAZER';
    }
  }
];

// ‚îÄ‚îÄ BUILD AGENT LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function buildAgentList() {
  var html = '';
  _agents.forEach(function(ag, i) {
    html += '<div class="agent-card" id="agCard' + i + '">'
      + '<div class="agent-hd" onclick="SQUAD.toggleAgent(' + i + ')">'
        + '<div class="agent-ico">' + ag.ico + '</div>'
        + '<div class="agent-meta">'
          + '<div class="agent-num">AGENTE 0' + (i + 1) + '</div>'
          + '<div class="agent-name">' + ag.name + '</div>'
          + '<div class="agent-role">' + ag.role + '</div>'
        + '</div>'
        + '<div class="agent-tag" id="agTag' + i + '">IDLE</div>'
      + '</div>'
      + '<div class="agent-body" id="agBody' + i + '">'
        + '<div class="agent-text" id="agText' + i + '"></div>'
      + '</div>'
    + '</div>';
  });
  document.getElementById('agentList').innerHTML = html;
})();

SQUAD.toggleAgent = function(i) {
  document.getElementById('agBody' + i).classList.toggle('open');
};

// ‚îÄ‚îÄ GEMINI API CALL ‚Äî com fallback autom√°tico de modelo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Ordem de tentativa: modelos gratuitos dispon√≠veis para novos usu√°rios em 2025/2026
var _MODELS = [
  'gemini-2.0-flash-lite',
  'gemini-1.5-flash',
  'gemini-1.5-flash-8b',
  'gemini-1.5-pro'
];
var _activeModel = null; // guarda o modelo que funcionou para reusar

function _callGemini(prompt, callback) {
  if (!_key) {
    callback('API Key n√£o configurada. Salve sua key acima.', null);
    return;
  }
  // Se j√° descobrimos qual modelo funciona, usa direto
  if (_activeModel) {
    _tryModel(_activeModel, prompt, callback);
  } else {
    _tryModelChain(0, prompt, callback);
  }
}

function _tryModelChain(idx, prompt, callback) {
  if (idx >= _MODELS.length) {
    callback('Nenhum modelo Gemini dispon√≠vel para esta key. Verifique se a key est√° ativa no Google AI Studio.', null);
    return;
  }
  var model = _MODELS[idx];
  _tryModel(model, prompt, function(err, result) {
    if (err && (err.indexOf('404') !== -1 || err.indexOf('not found') !== -1 || err.indexOf('no longer available') !== -1 || err.indexOf('NOT_FOUND') !== -1)) {
      // Este modelo n√£o est√° dispon√≠vel, tenta o pr√≥ximo
      _tryModelChain(idx + 1, prompt, callback);
    } else if (!err) {
      // Funcionou! Salva para as pr√≥ximas chamadas
      if (_activeModel !== model) {
        _activeModel = model;
        var badge = document.getElementById('modelBadge');
        if (badge) badge.textContent = model.replace('gemini-','').toUpperCase();
        SQUAD.toast('‚úì Modelo: ' + model);
      }
      callback(null, result);
    } else {
      callback(err, null);
    }
  });
}

function _tryModel(model, prompt, callback) {
  var url = 'https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + _key;

  var body = JSON.stringify({
    contents: [{ role: 'user', parts: [{ text: prompt }] }],
    generationConfig: { maxOutputTokens: 1400, temperature: 0.85 }
  });

  var xhr = new XMLHttpRequest();
  xhr.open('POST', url, true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.timeout = 90000;

  xhr.onreadystatechange = function() {
    if (xhr.readyState !== 4) return;

    if (xhr.status === 0) {
      callback('Sem resposta da API. Verifique sua conex√£o √† internet.', null);
      return;
    }

    var data;
    try { data = JSON.parse(xhr.responseText); }
    catch(e) { callback('Resposta inv√°lida da API (HTTP ' + xhr.status + ').', null); return; }

    if (xhr.status === 404) {
      var m404 = (data.error && data.error.message) || 'NOT_FOUND';
      callback('404: ' + m404, null);
      return;
    }
    if (xhr.status === 400) {
      var m400 = (data.error && data.error.message) || 'Requisi√ß√£o inv√°lida';
      callback('Erro 400: ' + m400, null);
      return;
    }
    if (xhr.status === 403) {
      callback('Erro 403: Key sem permiss√£o. Verifique no Google AI Studio.', null);
      return;
    }
    if (xhr.status === 429) {
      callback('Limite atingido (429). Aguarde 1 minuto e tente novamente.', null);
      return;
    }
    if (xhr.status !== 200) {
      var mErr = (data.error && data.error.message) || ('HTTP ' + xhr.status);
      callback('Erro: ' + mErr, null);
      return;
    }
    if (data.error) {
      callback('Gemini: ' + (data.error.message || JSON.stringify(data.error)), null);
      return;
    }

    var text = '';
    try { text = data.candidates[0].content.parts[0].text; }
    catch(e) {
      var reason = (data.candidates && data.candidates[0] && data.candidates[0].finishReason) || 'desconhecido';
      callback('Resposta vazia. Motivo: ' + reason, null);
      return;
    }

    callback(null, text);
  };

  xhr.onerror   = function() { callback('Erro de rede. Verifique sua conex√£o.', null); };
  xhr.ontimeout = function() { callback('Timeout (90s). Tente novamente.', null); };
  xhr.send(body);
}

// ‚îÄ‚îÄ LAUNCH PIPELINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SQUAD.launch = function() {
  if (_busy) return;

  // Validate key
  if (!_key) {
    SQUAD.toast('‚ö† Configure e salve sua Gemini API Key primeiro!');
    document.getElementById('keyInput').focus();
    return;
  }

  // Validate required field
  var desc = (document.getElementById('fDesc').value || '').trim();
  if (!desc) {
    SQUAD.toast('‚ö† Descreva o produto / servi√ßo / tema!');
    document.getElementById('fDesc').focus();
    return;
  }

  _brief = {
    brand: (document.getElementById('fBrand').value || '').trim() || 'Marca',
    niche: document.getElementById('fNiche').value || 'geral',
    obj:   document.getElementById('fObj').value   || 'engajamento',
    desc:  desc,
    tone:  document.getElementById('fTone').value  || 'moderno',
    aud:   (document.getElementById('fAud').value  || '').trim()
  };

  _busy = true;
  _outs = [];
  _mj   = '';

  // Reset agent UI
  _agents.forEach(function(_, i) {
    var c = document.getElementById('agCard' + i);
    c.classList.remove('running', 'done', 'error');
    document.getElementById('agTag'  + i).textContent = 'IDLE';
    document.getElementById('agBody' + i).classList.remove('open');
    document.getElementById('agText' + i).innerHTML = '';
  });
  document.getElementById('promptBox').classList.remove('show');
  document.getElementById('legendaBox').classList.remove('show');
  document.getElementById('extraOutputs').innerHTML = '';
  document.getElementById('btnArte').classList.remove('show');

  var btn = document.getElementById('btnGo');
  btn.disabled = true;
  btn.textContent = '‚è≥ SQUAD EM A√á√ÉO...';

  document.getElementById('progWrap').classList.add('show');
  _setProgress(0);

  _runAgent(0);
};

function _runAgent(i) {
  if (i >= _agents.length) {
    // All done
    _setProgress(_agents.length);
    var btn = document.getElementById('btnGo');
    btn.disabled = false;
    btn.textContent = '‚ñ∂ ACIONAR SQUAD';
    _busy = false;
    document.getElementById('btnArte').classList.add('show');
    SQUAD.toast('‚úì Squad conclu√≠do! Gere a arte final abaixo.');
    setTimeout(function() {
      document.getElementById('btnArte').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 400);
    return;
  }

  _setProgress(i);

  var card = document.getElementById('agCard' + i);
  card.classList.remove('done', 'error');
  card.classList.add('running');
  document.getElementById('agTag'  + i).textContent = '...';
  document.getElementById('agBody' + i).classList.add('open');
  document.getElementById('agText' + i).innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
  card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

  var prompt = _agents[i].prompt();

  _callGemini(prompt, function(err, result) {
    card.classList.remove('running');

    if (err) {
      _outs.push('');
      card.classList.add('error');
      document.getElementById('agTag'  + i).textContent = '‚ö†';
      document.getElementById('agText' + i).innerHTML = '<span class="err-txt">‚ö† ' + _esc(err) + '</span>';
    } else {
      _outs.push(result);
      card.classList.add('done');
      document.getElementById('agTag'  + i).textContent = '‚úì';
      document.getElementById('agText' + i).innerHTML = _renderText(result.substring(0, 480) + (result.length > 480 ? '‚Ä¶' : ''));
      _handleOutput(i, result);
    }

    // Small pause then continue
    setTimeout(function() { _runAgent(i + 1); }, 250);
  });
}

function _handleOutput(i, text) {
  // Agent 2 = Dir Fotografia ‚Üí extract image prompt
  if (i === 2) {
    var patterns = [
      /\*\*PROMPT DE IMAGEM\*\*\n([\s\S]+?)(?=\n\n\*\*|\n\*\*|$)/i,
      /PROMPT DE IMAGEM[:\s]*\n([\s\S]+?)(?=\n\n\*\*|\n\*\*|$)/i
    ];
    _mj = '';
    for (var p = 0; p < patterns.length; p++) {
      var m = text.match(patterns[p]);
      if (m && m[1].trim().length > 20) {
        _mj = m[1].trim().replace(/^```\w*\n?/, '').replace(/```$/, '').trim();
        break;
      }
    }
    if (!_mj) _mj = _brief.niche + ' professional atmosphere, cinematic lighting, 8k resolution, no text, no watermark';
    document.getElementById('promptTxt').textContent = _mj;
    document.getElementById('promptBox').classList.add('show');
  }

  // Agent 4 = Legenda
  if (i === 4) {
    document.getElementById('legendaTxt').textContent = text.replace(/\*\*/g, '');
    document.getElementById('legendaBox').classList.add('show');

    // Build collapsibles for previous agents
    var html = '';
    [{title:'üé® DIR. DE ARTE', idx:3}, {title:'üì∏ DIR. FOTOGRAFIA', idx:2},
     {title:'‚úçÔ∏è COPY DO CARD', idx:1}, {title:'üß† ESTRAT√âGIA COMPLETA', idx:0}]
    .forEach(function(d) {
      var id = 'coll' + d.idx;
      html += '<div class="collapsible">'
        + '<div class="coll-hd" onclick="SQUAD.toggleColl(\'' + id + '\')">'
          + '<div class="coll-title">' + d.title + '</div>'
          + '<span style="color:#555">‚ñæ</span>'
        + '</div>'
        + '<div class="coll-body" id="' + id + '">' + _renderText(_outs[d.idx] || '') + '</div>'
      + '</div>';
    });
    document.getElementById('extraOutputs').innerHTML = html;
  }

  if (i === 5) {
    document.getElementById('extraOutputs').innerHTML +=
      '<div class="collapsible">'
      + '<div class="coll-hd" onclick="SQUAD.toggleColl(\'collTraf\')">'
        + '<div class="coll-title">üìä TR√ÅFEGO PAGO</div>'
        + '<span style="color:#555">‚ñæ</span>'
      + '</div>'
      + '<div class="coll-body" id="collTraf">' + _renderText(text) + '</div>'
      + '</div>';
  }

  if (i === 6) {
    document.getElementById('extraOutputs').innerHTML +=
      '<div class="collapsible" style="border-color:rgba(255,204,0,.25)">'
      + '<div class="coll-hd" onclick="SQUAD.toggleColl(\'collDC\')">'
        + '<div class="coll-title">üèÜ DIR. CRIATIVO ‚Äî REVIS√ÉO FINAL</div>'
        + '<span style="color:#555">‚ñæ</span>'
      + '</div>'
      + '<div class="coll-body open" id="collDC">' + _renderText(text) + '</div>'
      + '</div>';
  }
}

function _setProgress(cur) {
  var pct = Math.round(cur / _agents.length * 100);
  document.getElementById('progFill').style.width = pct + '%';
  document.getElementById('progPct').textContent = pct + '%';
  document.getElementById('progLabel').textContent = cur < _agents.length
    ? 'Agente ' + (cur + 1) + ': ' + _agents[cur].name
    : '‚úì Pipeline conclu√≠do!';
}

// ‚îÄ‚îÄ ARTE FINAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SQUAD.openModal = function() {
  var modal = document.getElementById('modal');
  modal.classList.add('open');

  // Reset modal state
  document.getElementById('previewSpinner').classList.remove('hidden');
  document.getElementById('spinTxt').textContent = 'GERANDO IMAGEM...';
  document.getElementById('modalStatus').className = 'modal-status';
  document.getElementById('modalStatus').textContent = 'Gerando com Pollinations AI...';
  document.getElementById('btnDownload').disabled = true;
  document.getElementById('stepsList').innerHTML = '';
  document.getElementById('previewInner').innerHTML = '';
  document.getElementById('btnArte').disabled = true;

  // Set aspect ratio
  document.getElementById('previewRatio').style.paddingTop = (_fmt.h / _fmt.w * 100) + '%';

  // Set render target size
  var rt = document.getElementById('RENDER_TARGET');
  rt.style.cssText = 'position:fixed;left:-19999px;top:0;width:' + _fmt.w + 'px;height:' + _fmt.h + 'px;overflow:hidden;z-index:-1;pointer-events:none;';

  _artSteps = [];
  _generateArt();
};

function _addStep(txt) {
  if (_artSteps.length > 0) _artSteps[_artSteps.length - 1].s = 'ok';
  _artSteps.push({ t: txt, s: 'active' });
  _renderSteps();
  document.getElementById('spinTxt').textContent = txt.substring(0, 24).toUpperCase();
}

function _renderSteps() {
  document.getElementById('stepsList').innerHTML = _artSteps.map(function(s) {
    var ic = s.s === 'ok' ? '‚úì' : s.s === 'err' ? '‚úï' : '‚óè';
    return '<div class="step-item ' + s.s + '">' + ic + ' ' + _esc(s.t) + '</div>';
  }).join('');
}

function _generateArt() {
  _addStep('Gerando imagem com Pollinations AI...');
  var seed = Math.floor(Math.random() * 99999);
  var enc = encodeURIComponent(_mj.substring(0, 350));
  var url = 'https://image.pollinations.ai/prompt/' + enc
    + '?width=' + _fmt.w + '&height=' + _fmt.h
    + '&seed=' + seed + '&model=flux&nologo=true&enhance=true';

  var img = new Image();
  img.crossOrigin = 'anonymous';

  var timer = setTimeout(function() {
    _addStep('Timeout na imagem ‚Äî usando gradiente...');
    _buildCard(null);
  }, 20000);

  img.onload = function() {
    clearTimeout(timer);
    _addStep('Imagem gerada! Montando layout...');
    _buildCard(img);
  };
  img.onerror = function() {
    clearTimeout(timer);
    _addStep('Erro na imagem ‚Äî usando gradiente...');
    _buildCard(null);
  };
  img.src = url;
}

function _buildCard(imgEl) {
  // Parse color/style JSON from Dir. Arte
  var cs = {};
  var sm = (_outs[3] || '').match(/CARD_JSON_START\s*([\s\S]*?)\s*CARD_JSON_END/);
  if (sm) { try { cs = JSON.parse(sm[1].trim()); } catch(e) {} }

  var C = {
    bg1:     cs.bg1     || '#0a0a0a',
    bg2:     cs.bg2     || '#1a1a2e',
    overlay: cs.overlay || 'rgba(0,0,0,0.65)',
    hlColor: cs.hlColor || '#FFFFFF',
    hlFont:  cs.hlFont  || 'Bebas Neue',
    hlSize:  parseInt(cs.hlSize) || (_fmt.h > 1500 ? 110 : _fmt.h > 1100 ? 88 : 72),
    eyColor: cs.eyColor || '#FFCC00',
    stColor: cs.stColor || 'rgba(255,255,255,0.80)',
    badgeBg: cs.badgeBg || '#FF3C00',
    badgeFg: cs.badgeFg || '#FFFFFF',
    ctaColor:cs.ctaColor|| '#FFFFFF',
    acc1:    cs.acc1    || '#FF3C00',
    acc2:    cs.acc2    || '#FFCC00',
    decor:   cs.decor   || 'rgba(255,255,255,0.04)'
  };

  // Extract copy fields
  function gF(label) {
    var rx = new RegExp('\\*\\*' + label + '\\*\\*\\n([^\\n\\*]+)', 'i');
    var m = (_outs[1] || '').match(rx);
    return m ? m[1].trim().replace(/^\[|\]$/g, '') : '';
  }
  var badge    = gF('BADGE');
  var eyebrow  = gF('EYEBROW');
  var headline = gF('HEADLINE') || _brief.brand.toUpperCase();
  var subtext  = gF('SUBTEXT');
  var cta      = gF('CTA');
  var brandTag = '@' + _brief.brand.toLowerCase().replace(/\s+/g, '');

  var W = _fmt.w, H = _fmt.h, pad = Math.round(W * 0.065), hl = C.hlSize;

  function el(tag, css, txt) {
    var d = document.createElement(tag);
    d.style.cssText = css;
    if (txt !== undefined) d.textContent = txt;
    return d;
  }

  // ‚îÄ‚îÄ Background ‚îÄ‚îÄ
  var bgCss;
  if (imgEl) {
    var cv = document.createElement('canvas');
    cv.width = W; cv.height = H;
    var ctx = cv.getContext('2d');
    var iR = imgEl.naturalWidth / imgEl.naturalHeight, cR = W / H;
    var dw, dh, dx, dy;
    if (iR > cR) { dh = H; dw = H * iR; dx = (W - dw) / 2; dy = 0; }
    else          { dw = W; dh = W / iR; dx = 0; dy = (H - dh) / 2; }
    ctx.drawImage(imgEl, dx, dy, dw, dh);
    bgCss = 'background-image:url(' + cv.toDataURL('image/jpeg', .9) + ');background-size:cover;background-position:center;';
  } else {
    bgCss = 'background:linear-gradient(160deg,' + C.bg1 + ' 0%,' + C.bg2 + ' 100%);';
  }

  var card = el('div', 'position:relative;width:' + W + 'px;height:' + H + 'px;overflow:hidden;' + bgCss);

  // Dark gradient overlay
  card.appendChild(el('div',
    'position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.92) 0%,rgba(0,0,0,.38) 55%,rgba(0,0,0,.08) 100%);'));

  // SVG decor circles
  var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
  svg.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;pointer-events:none;';
  function circ(cx, cy, r) {
    var c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    c.setAttribute('cx', cx); c.setAttribute('cy', cy);
    c.setAttribute('r', r);   c.setAttribute('fill', C.decor);
    return c;
  }
  svg.appendChild(circ(Math.round(W * .84), Math.round(H * .10), Math.round(W * .18)));
  svg.appendChild(circ(Math.round(W * .08), Math.round(H * .38), Math.round(W * .09)));
  card.appendChild(svg);

  // Badge
  if (badge) {
    var bfs = Math.round(hl * .16);
    card.appendChild(el('div',
      'position:absolute;top:' + pad + 'px;left:' + pad + 'px;'
      + 'background:' + C.badgeBg + ';color:' + C.badgeFg + ';'
      + 'font-family:Space Mono,monospace;font-size:' + bfs + 'px;letter-spacing:3px;'
      + 'padding:' + Math.round(bfs * .5) + 'px ' + Math.round(bfs * 1.1) + 'px;'
      + 'border-radius:4px;text-transform:uppercase;z-index:10;',
      badge));
  }

  // Brand tag
  card.appendChild(el('div',
    'position:absolute;top:' + pad + 'px;right:' + pad + 'px;'
    + 'font-family:Space Mono,monospace;font-size:' + Math.round(hl * .13) + 'px;'
    + 'color:rgba(255,255,255,.35);letter-spacing:2px;z-index:10;',
    brandTag));

  // Content block
  var cont = el('div',
    'position:absolute;bottom:' + Math.round(pad * 1.4) + 'px;'
    + 'left:' + pad + 'px;right:' + pad + 'px;z-index:10;');

  if (eyebrow) {
    cont.appendChild(el('div',
      'font-family:Space Mono,monospace;font-size:' + Math.round(hl * .19) + 'px;'
      + 'color:' + C.eyColor + ';letter-spacing:4px;text-transform:uppercase;'
      + 'margin-bottom:' + Math.round(hl * .12) + 'px;',
      eyebrow));
  }
  cont.appendChild(el('div',
    'font-family:' + C.hlFont + ',Impact,sans-serif;font-weight:700;'
    + 'font-size:' + hl + 'px;color:' + C.hlColor + ';line-height:1.0;'
    + 'text-transform:uppercase;letter-spacing:1px;'
    + 'margin-bottom:' + Math.round(hl * .14) + 'px;'
    + 'text-shadow:0 2px 30px rgba(0,0,0,.7);',
    headline));

  if (subtext) {
    cont.appendChild(el('div',
      'font-family:Inter,sans-serif;font-size:' + Math.round(hl * .21) + 'px;'
      + 'color:' + C.stColor + ';line-height:1.45;'
      + 'margin-bottom:' + Math.round(hl * .22) + 'px;',
      subtext));
  }
  if (cta) {
    var ctaFs = Math.round(hl * .17);
    cont.appendChild(el('div',
      'display:inline-block;font-family:Space Mono,monospace;font-size:' + ctaFs + 'px;'
      + 'color:' + C.ctaColor + ';border:1px solid rgba(255,255,255,.4);'
      + 'padding:' + Math.round(ctaFs * .6) + 'px ' + Math.round(ctaFs * 1.4) + 'px;'
      + 'letter-spacing:2px;text-transform:uppercase;border-radius:3px;',
      cta));
  }
  card.appendChild(cont);

  // Accent line bottom
  card.appendChild(el('div',
    'position:absolute;bottom:0;left:0;right:0;height:4px;'
    + 'background:linear-gradient(90deg,' + C.acc1 + ',' + C.acc2 + ');'));

  // Inject into hidden render target
  var rt = document.getElementById('RENDER_TARGET');
  rt.innerHTML = '';
  rt.appendChild(card);

  // Wait for fonts, then show scaled preview
  setTimeout(function() {
    var wrapW = document.getElementById('previewWrap').offsetWidth;
    var scale = wrapW / W;

    var inner = document.getElementById('previewInner');
    inner.innerHTML = '';
    var sw = document.createElement('div');
    sw.style.cssText = 'position:absolute;top:0;left:0;'
      + 'width:' + W + 'px;height:' + H + 'px;'
      + 'transform:scale(' + scale + ');transform-origin:top left;';
    sw.appendChild(card.cloneNode(true));
    inner.appendChild(sw);

    if (_artSteps.length > 0) _artSteps[_artSteps.length - 1].s = 'ok';
    _renderSteps();

    document.getElementById('previewSpinner').classList.add('hidden');
    document.getElementById('modalStatus').className = 'modal-status ok';
    document.getElementById('modalStatus').textContent = '‚úì Arte gerada! Verifique e baixe abaixo.';
    document.getElementById('btnDownload').disabled = false;
    document.getElementById('btnArte').disabled = false;
  }, 800);
}

// ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SQUAD.download = function() {
  var btn = document.getElementById('btnDownload');
  btn.disabled = true;
  btn.textContent = '‚è≥ CAPTURANDO...';

  var rt = document.getElementById('RENDER_TARGET');
  var cardEl = rt.firstElementChild;
  if (!cardEl) {
    SQUAD.toast('‚ö† Gere a arte primeiro!');
    btn.disabled = false; btn.textContent = '‚¨á BAIXAR PNG';
    return;
  }

  // Bring on-screen briefly for capture
  rt.style.left = '0';
  rt.style.zIndex = '9999';

  setTimeout(function() {
    html2canvas(cardEl, {
      width: _fmt.w, height: _fmt.h, scale: 1,
      useCORS: true, allowTaint: true,
      backgroundColor: null, logging: false
    }).then(function(canvas) {
      rt.style.left = '-19999px'; rt.style.zIndex = '-1';

      canvas.toBlob(function(blob) {
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = _brief.brand.replace(/\s+/g, '-').toLowerCase() + '-' + _fmt.w + 'x' + _fmt.h + '.png';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(function() { URL.revokeObjectURL(url); }, 3000);
        btn.textContent = '‚úì BAIXADO!';
        SQUAD.toast('‚úì PNG salvo com sucesso!');
        setTimeout(function() { btn.disabled = false; btn.textContent = '‚¨á BAIXAR PNG'; }, 3000);
      }, 'image/png', 1.0);

    }).catch(function() {
      rt.style.left = '-19999px'; rt.style.zIndex = '-1';
      // HTML fallback
      var h = '<!DOCTYPE html><html><head><meta charset="UTF-8">'
        + '<style>*{margin:0;padding:0}body{width:' + _fmt.w + 'px;height:' + _fmt.h + 'px;overflow:hidden}</style>'
        + '</head><body>' + rt.innerHTML + '</body></html>';
      var b = new Blob([h], { type: 'text/html' });
      var u = URL.createObjectURL(b);
      var a = document.createElement('a');
      a.href = u;
      a.download = _brief.brand.replace(/\s+/g, '-').toLowerCase() + '.html';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(u);
      btn.disabled = false; btn.textContent = '‚¨á BAIXAR PNG';
      SQUAD.toast('Salvo como HTML ‚Äî abra no Chrome e use Ctrl+Shift+P ‚Üí Screenshot');
    });
  }, 500);
};

SQUAD.closeModal = function() {
  document.getElementById('modal').classList.remove('open');
  document.getElementById('btnArte').disabled = false;
};

// ‚îÄ‚îÄ UTIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SQUAD.toggleColl = function(id) { document.getElementById(id).classList.toggle('open'); };

SQUAD.copyEl = function(id, btn) {
  var txt = document.getElementById(id).textContent;
  function ok() {
    var orig = btn.textContent;
    btn.textContent = '‚úì Copiado!';
    setTimeout(function() { btn.textContent = orig; }, 2000);
  }
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt).then(ok);
  } else {
    var ta = document.createElement('textarea');
    ta.value = txt; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); ok();
  }
};

SQUAD.toast = function(msg) {
  var t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(function() { if (t.parentNode) t.parentNode.removeChild(t); }, 2800);
};

function _renderText(t) {
  return (t || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
}

function _esc(s) {
  return String(s || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SQUAD.loadKey();
</script>
</body>
</html>
