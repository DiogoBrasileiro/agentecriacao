<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SQUAD DUPLO ‚Äî Card Creator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{font-size:16px}
body{background:#080808;color:#e8e8e8;font-family:'DM Sans',sans-serif;min-height:100%;overflow-x:hidden;-webkit-font-smoothing:antialiased}

:root{
  --bg:#080808;--s1:#101010;--s2:#181818;--s3:#222;
  --br:#2a2a2a;--br2:#333;
  --red:#e8390e;--gold:#c9a84c;--grn:#1db954;
  --blue:#38bdf8;--pur:#a78bfa;
  --txt:#e8e8e8;--sub:#686868;--sub2:#444;
  --r:14px;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr{
  position:sticky;top:0;z-index:300;
  background:rgba(8,8,8,.97);border-bottom:1px solid var(--br);
  backdrop-filter:blur(20px);padding:0 18px;height:54px;
  display:flex;align-items:center;justify-content:space-between;
}
.logo{font-family:'Syne';font-weight:800;font-size:17px;letter-spacing:5px;text-transform:uppercase}
.logo em{color:var(--red);font-style:normal}
.hbadge{
  font-family:'Space Mono';font-size:9px;color:var(--grn);
  border:1px solid rgba(29,185,84,.3);border-radius:20px;
  padding:4px 10px;display:flex;align-items:center;gap:5px;
}
.hbadge::before{content:'';width:5px;height:5px;border-radius:50%;background:var(--grn);animation:bl 2s infinite;flex-shrink:0}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.1}}

/* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
.pg{padding:16px 14px 80px;max-width:560px;margin:0 auto}

/* ‚îÄ‚îÄ BOX ‚îÄ‚îÄ */
.box{background:var(--s1);border:1px solid var(--br);border-radius:var(--r);padding:18px;margin-bottom:10px}
.box-lbl{font-family:'Space Mono';font-size:9px;letter-spacing:3px;color:var(--red);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.box-lbl::after{content:'';flex:1;height:1px;background:var(--br)}

/* ‚îÄ‚îÄ KEY ‚îÄ‚îÄ */
.ks{display:flex;align-items:center;gap:9px;padding:11px 13px;border-radius:11px;background:var(--s2);font-size:13px;margin-bottom:9px;border:1px solid var(--br);color:var(--sub)}
.ks.ok{color:var(--grn);border-color:rgba(29,185,84,.2)}
.ks-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0}
.kr{display:flex;gap:7px}
.ki{flex:1;min-width:0;background:var(--s2);border:1px solid var(--br);color:var(--txt);padding:12px 13px;border-radius:11px;font-family:'Space Mono';font-size:12px;outline:none;transition:.2s}
.ki:focus{border-color:rgba(232,57,14,.5)}
.btn-ks{background:var(--red);color:#fff;border:none;padding:12px 16px;border-radius:11px;font-family:'Syne';font-weight:700;font-size:14px;cursor:pointer;white-space:nowrap}
.btn-ks:active{opacity:.75}
.btn-kc{background:var(--s2);border:1px solid var(--br);color:var(--sub);padding:12px 13px;border-radius:11px;font-size:13px;cursor:pointer;display:none}
.kn{font-size:12px;color:var(--sub);margin-top:8px;line-height:1.6}
.kn a{color:#5b9cf6;text-decoration:none}

/* ‚îÄ‚îÄ FIELDS ‚îÄ‚îÄ */
.f{margin-bottom:11px}
.f:last-child{margin-bottom:0}
.lbl{display:block;font-size:11px;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.inp,.ta{display:block;width:100%;background:var(--s2);border:1px solid var(--br);color:var(--txt);padding:12px 13px;border-radius:11px;font-family:'DM Sans';font-size:15px;outline:none;transition:.2s;appearance:none}
.inp:focus,.ta:focus{border-color:rgba(232,57,14,.5)}
.ta{resize:vertical;min-height:80px;line-height:1.55}
.sel-w{position:relative}
.sel-w::after{content:'‚ñæ';position:absolute;right:13px;top:50%;transform:translateY(-50%);color:var(--sub);pointer-events:none}
select.inp{padding-right:34px;-webkit-appearance:none;cursor:pointer}
select.inp option{background:#111}

/* ‚îÄ‚îÄ FORMAT PICKER ‚îÄ‚îÄ */
.fmt-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px}
.fc{background:var(--s2);border:1.5px solid var(--br);border-radius:12px;padding:12px 6px;cursor:pointer;text-align:center;display:flex;flex-direction:column;align-items:center;gap:6px;transition:.2s}
.fc.on{border-color:var(--red);background:rgba(232,57,14,.07)}
.fc-th{background:#1e1e1e;border:1.5px solid #333;border-radius:3px;transition:.2s}
.fc.on .fc-th{border-color:var(--red)}
.fc-nm{font-family:'Syne';font-weight:700;font-size:12px;color:var(--sub);letter-spacing:1px}
.fc-sz{font-family:'Space Mono';font-size:8px;color:#444}
.fc.on .fc-nm{color:var(--red)}

/* ‚îÄ‚îÄ LAUNCH ‚îÄ‚îÄ */
.btn-go{width:100%;padding:17px;margin-bottom:10px;background:var(--red);color:#fff;border:none;border-radius:14px;font-family:'Syne';font-weight:800;font-size:18px;letter-spacing:3px;cursor:pointer;transition:.15s;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-go:active{opacity:.85;transform:scale(.98)}
.btn-go:disabled{background:#1a1a1a;color:#333;cursor:not-allowed;transform:none;opacity:1}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.prog{display:none;margin-bottom:10px}
.prog.on{display:block}
.prog-track{height:2px;background:var(--s3);border-radius:1px;overflow:hidden;margin-bottom:6px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--red),var(--gold));width:0%;transition:width .5s}
.prog-info{display:flex;justify-content:space-between;font-family:'Space Mono';font-size:10px;color:var(--sub)}

/* ‚îÄ‚îÄ DEPARTMENT ‚îÄ‚îÄ */
.dept{margin-bottom:10px}
.dept-header{
  display:flex;align-items:center;gap:10px;
  padding:12px 14px 10px;
}
.dept-line{flex:1;height:1px;background:var(--br)}
.dept-name{
  font-family:'Space Mono';font-size:9px;letter-spacing:2px;
  color:var(--sub2);white-space:nowrap;
}
.dept-badge{
  font-family:'Space Mono';font-size:8px;padding:3px 8px;
  border-radius:5px;border:1px solid var(--br);color:var(--sub2);
}
.dept-badge.done{border-color:rgba(29,185,84,.4);color:var(--grn);background:rgba(29,185,84,.06)}

/* ‚îÄ‚îÄ AGENT CARD ‚îÄ‚îÄ */
.ag{background:var(--s1);border:1px solid var(--br);border-radius:12px;margin-bottom:6px;overflow:hidden;transition:border-color .3s}
.ag.run{border-color:var(--red)}
.ag.done{border-color:rgba(29,185,84,.35)}
.ag.refine{border-color:var(--gold)}

/* Role stripe */
.ag-stripe{height:2px;width:100%}
.ag.creator .ag-stripe{background:linear-gradient(90deg,var(--blue),transparent)}
.ag.reviewer .ag-stripe{background:linear-gradient(90deg,var(--gold),transparent)}

.ag-top{display:flex;align-items:center;gap:12px;padding:14px;cursor:pointer;user-select:none}
.ag-ico{width:40px;height:40px;border-radius:11px;flex-shrink:0;background:var(--s2);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:18px;transition:.2s}
.ag.run .ag-ico{background:rgba(232,57,14,.1);border-color:var(--red)}
.ag.done .ag-ico{background:rgba(29,185,84,.07);border-color:rgba(29,185,84,.3)}
.ag.refine .ag-ico{background:rgba(201,168,76,.1);border-color:rgba(201,168,76,.4)}
.ag-meta{flex:1;min-width:0}
.ag-role-tag{
  font-family:'Space Mono';font-size:8px;letter-spacing:1px;
  padding:2px 7px;border-radius:4px;display:inline-block;margin-bottom:3px;
}
.ag.creator .ag-role-tag{background:rgba(56,189,248,.1);color:var(--blue);border:1px solid rgba(56,189,248,.2)}
.ag.reviewer .ag-role-tag{background:rgba(201,168,76,.1);color:var(--gold);border:1px solid rgba(201,168,76,.2)}
.ag-num{font-family:'Space Mono';font-size:8px;color:var(--sub2)}
.ag-name{font-family:'Syne';font-weight:700;font-size:15px;line-height:1.15}
.ag-desc{font-size:11px;color:var(--sub);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ag-tag{font-family:'Space Mono';font-size:9px;flex-shrink:0;padding:4px 8px;border-radius:7px;border:1px solid var(--br);color:var(--sub2)}
.ag.run .ag-tag{border-color:var(--red);color:var(--red)}
.ag.done .ag-tag{border-color:var(--grn);color:var(--grn)}
.ag.refine .ag-tag{border-color:var(--gold);color:var(--gold)}
.ag-body{display:none;padding:0 14px 14px;border-top:1px solid var(--br)}
.ag-body.open{display:block;padding-top:12px}
.ag-txt{font-size:12px;line-height:1.85;color:#888;white-space:pre-wrap;word-break:break-word}
.ag-txt strong{color:var(--gold)}
.ag-txt .approved{color:var(--grn);font-family:'Space Mono';font-size:10px}
.ag-txt .refined{color:var(--gold);font-family:'Space Mono';font-size:10px}

/* dots */
.dots{display:flex;gap:4px;padding:8px 0}
.dots span{width:5px;height:5px;border-radius:50%;background:var(--red);animation:dt 1.2s infinite}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes dt{0%,100%{opacity:.2;transform:translateY(0)}50%{opacity:1;transform:translateY(-5px)}}

/* ‚îÄ‚îÄ OUTPUT BOXES ‚îÄ‚îÄ */
.out-copy{background:var(--s1);border:1px solid rgba(201,168,76,.25);border-radius:14px;padding:18px;margin-bottom:10px;display:none}
.out-copy.on{display:block}
.out-lbl{font-family:'Space Mono';font-size:9px;letter-spacing:2px;margin-bottom:12px}
.out-lbl.gold{color:var(--gold)}
.out-lbl.grn{color:var(--grn)}
.out-titulo{font-family:'Syne';font-weight:800;font-size:24px;line-height:1.15;color:var(--txt);margin-bottom:7px}
.out-sub{font-size:14px;line-height:1.6;color:#bbb;margin-bottom:14px}
.leg-sep{border-top:1px solid var(--br);padding-top:14px;margin-top:2px}
.leg-lbl{font-family:'Space Mono';font-size:9px;color:var(--sub);letter-spacing:2px;margin-bottom:7px}
.leg-txt{font-size:13px;line-height:1.85;color:#999;white-space:pre-wrap;word-break:break-word}

.out-prompt{background:#050c08;border:1px solid rgba(29,185,84,.2);border-radius:14px;padding:16px;margin-bottom:10px;display:none}
.out-prompt.on{display:block}
.out-prompt-txt{font-family:'Space Mono';font-size:11px;color:#4dde8a;line-height:1.65;word-break:break-all;white-space:pre-wrap}

.cp-btn{display:inline-flex;align-items:center;gap:5px;margin-top:11px;background:var(--s2);border:1px solid var(--br);color:var(--sub);padding:7px 13px;border-radius:8px;font-size:12px;cursor:pointer}
.cp-btn:active{background:var(--s3)}

/* ‚îÄ‚îÄ ARTE BTN ‚îÄ‚îÄ */
.btn-arte{width:100%;padding:17px;margin-bottom:10px;background:linear-gradient(135deg,#1a0a3d,#5b21b6,#7c3aed);color:#fff;border:none;border-radius:14px;font-family:'Syne';font-weight:800;font-size:18px;letter-spacing:2px;cursor:pointer;display:none;align-items:center;justify-content:center;gap:10px;text-transform:uppercase}
.btn-arte.on{display:flex}
.btn-arte:active{opacity:.85;transform:scale(.98)}
.btn-arte:disabled{background:#1a1a1a;color:#333;cursor:not-allowed;transform:none;opacity:1}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.95);backdrop-filter:blur(16px);display:none;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:14px 14px 60px}
.modal.open{display:flex}
.modal-inner{background:#0e0e0e;border:1px solid var(--br);border-radius:20px;overflow:hidden;width:100%;max-width:560px;margin:auto}
.modal-hdr{padding:16px 18px;border-bottom:1px solid var(--br);display:flex;align-items:center;justify-content:space-between}
.modal-t{font-family:'Syne';font-weight:800;font-size:19px;letter-spacing:1px}
.modal-t em{color:var(--pur);font-style:normal}
.modal-x{width:32px;height:32px;border-radius:9px;border:1px solid var(--br);background:transparent;color:var(--sub);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-body{padding:16px;display:flex;flex-direction:column;gap:13px;align-items:center}

.steps-log{width:100%;background:var(--s2);border-radius:11px;padding:11px 13px}
.step-item{font-family:'Space Mono';font-size:10px;color:var(--sub2);padding:3px 0;display:flex;align-items:flex-start;gap:7px;line-height:1.5}
.step-item.active{color:var(--gold)}
.step-item.ok{color:var(--grn)}
.step-item.err{color:var(--red)}

.prev-wrap{width:100%;position:relative;border-radius:14px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.9),0 0 0 1px rgba(255,255,255,.04)}
.prev-ratio{width:100%;position:relative}
.prev-inner{position:absolute;inset:0;overflow:hidden}
.prev-spin{position:absolute;inset:0;background:rgba(0,0,0,.88);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:13px;z-index:5;border-radius:14px}
.prev-spin.gone{display:none}
.spinner{width:40px;height:40px;border-radius:50%;border:3px solid #1e1e1e;border-top-color:var(--pur);animation:sp .85s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.spin-txt{font-family:'Space Mono';font-size:10px;color:var(--pur);letter-spacing:1px;text-align:center;padding:0 20px}

.modal-status{font-family:'Space Mono';font-size:11px;color:var(--sub);text-align:center;width:100%;line-height:1.6}
.modal-status.ok{color:var(--grn)}
.modal-status.err{color:var(--red)}

.btn-dl{width:100%;padding:16px;background:linear-gradient(135deg,#4c1d95,#7c3aed,#a855f7);color:#fff;border:none;border-radius:13px;font-family:'Syne';font-weight:800;font-size:17px;letter-spacing:2px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;text-transform:uppercase;transition:opacity .15s}
.btn-dl:active{opacity:.85}
.btn-dl:disabled{background:#1a1a1a;color:#333;cursor:not-allowed;opacity:1}

/* hidden */
#RT{position:fixed;left:-39999px;top:0;z-index:-100;overflow:hidden;pointer-events:none}

/* toast */
.toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:#1a1a1a;color:#e8e8e8;padding:11px 20px;border-radius:22px;font-size:13px;z-index:9999;white-space:nowrap;border:1px solid #333;pointer-events:none;animation:tst .2s ease}
@keyframes tst{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translateX(-50%)}}

.err-box{background:rgba(232,57,14,.08);border:1px solid rgba(232,57,14,.25);border-radius:11px;padding:13px;font-size:13px;color:#ff8060;line-height:1.65;margin-bottom:10px;display:none}
.err-box.on{display:block}
</style>
</head>
<body>

<div class="hdr">
  <div class="logo">SQU<em>AD</em> DUPLO</div>
  <div class="hbadge" id="mBadge">GEMINI AUTO</div>
</div>

<div class="pg">

  <!-- KEY -->
  <div class="box">
    <div class="box-lbl">// Gemini API Key</div>
    <div class="ks" id="kSt"><span class="ks-dot"></span><span id="kMsg">Nenhuma key salva</span></div>
    <div class="kr">
      <input class="ki" id="kInp" type="password" placeholder="Cole sua key Gemini (AIza...)"/>
      <button class="btn-ks" onclick="saveKey()">Salvar</button>
      <button class="btn-kc" id="kClear" onclick="clearKey()">‚úï</button>
    </div>
    <div class="kn">Gr√°tis em <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a> ¬∑ <strong>Key salva no navegador.</strong></div>
  </div>

  <!-- BRIEF -->
  <div class="box">
    <div class="box-lbl">// Brief da empresa</div>

    <div class="f">
      <label class="lbl">Nome da empresa</label>
      <input class="inp" id="fNome" type="text" placeholder="Ex: Studio Fit, Caf√© Noir, TechVox..."/>
    </div>
    <div class="f">
      <label class="lbl">Nicho / Segmento</label>
      <input class="inp" id="fNicho" type="text" placeholder="Digite o nicho espec√≠fico da empresa..."/>
    </div>
    <div class="f">
      <label class="lbl">Sobre a empresa</label>
      <textarea class="ta" id="fEmpresa" placeholder="Descreva: o que faz, p√∫blico-alvo, diferenciais, valores, produtos ou servi√ßos principais..."></textarea>
    </div>
    <div class="f">
      <label class="lbl">O que abordar neste post?</label>
      <textarea class="ta" id="fAbordagem" style="min-height:66px" placeholder="Ex: lan√ßamento, promo√ß√£o, dica, autoridade, bastidores, depoimento, oferta..."></textarea>
    </div>
    <div class="f">
      <label class="lbl">Tom de voz</label>
      <div class="sel-w">
        <select class="inp" id="fTom">
          <option value="">Selecione o tom...</option>
          <option>Premium e Sofisticado</option>
          <option>Moderno e Direto</option>
          <option>Inspirador e Emocional</option>
          <option>Divertido e Descontra√≠do</option>
          <option>Autorit√°rio e Educativo</option>
          <option>Urgente e Persuasivo</option>
          <option>Minimalista e Clean</option>
          <option>Dark e Cinematogr√°fico</option>
        </select>
      </div>
    </div>
    <div class="f">
      <label class="lbl">Formato do card</label>
      <div class="fmt-grid">
        <div class="fc on" id="fc0" onclick="selFmt(0,1080,1080,'Feed 1:1')">
          <div class="fc-th" style="width:34px;height:34px"></div>
          <div class="fc-nm">FEED</div><div class="fc-sz">1080√ó1080</div>
        </div>
        <div class="fc" id="fc1" onclick="selFmt(1,1080,1350,'Portrait 4:5')">
          <div class="fc-th" style="width:26px;height:34px"></div>
          <div class="fc-nm">PORTRAIT</div><div class="fc-sz">1080√ó1350</div>
        </div>
        <div class="fc" id="fc2" onclick="selFmt(2,1080,1920,'Stories 9:16')">
          <div class="fc-th" style="width:18px;height:34px"></div>
          <div class="fc-nm">STORIES</div><div class="fc-sz">1080√ó1920</div>
        </div>
      </div>
    </div>
  </div>

  <div class="err-box" id="errBox"></div>

  <button class="btn-go" id="btnGo" onclick="iniciar()">‚ñ∂ ACIONAR SQUADS</button>

  <div class="prog" id="progWrap">
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-info"><span id="progLbl">Iniciando...</span><span id="progPct">0%</span></div>
  </div>

  <!-- DEPT 1: ESTRAT√âGIA -->
  <div class="dept" id="dept0">
    <div class="dept-header">
      <div class="dept-line"></div>
      <div class="dept-name">DEPARTAMENTO 01 ‚Äî ESTRAT√âGIA</div>
      <div class="dept-badge" id="dept0badge">AGUARDANDO</div>
      <div class="dept-line"></div>
    </div>
    <div id="ag0wrap"></div>
    <div id="ag1wrap"></div>
  </div>

  <!-- DEPT 2: COPY -->
  <div class="dept" id="dept1">
    <div class="dept-header">
      <div class="dept-line"></div>
      <div class="dept-name">DEPARTAMENTO 02 ‚Äî COPY</div>
      <div class="dept-badge" id="dept1badge">AGUARDANDO</div>
      <div class="dept-line"></div>
    </div>
    <div id="ag2wrap"></div>
    <div id="ag3wrap"></div>
  </div>

  <!-- DEPT 3: VISUAL -->
  <div class="dept" id="dept2">
    <div class="dept-header">
      <div class="dept-line"></div>
      <div class="dept-name">DEPARTAMENTO 03 ‚Äî DIRE√á√ÉO VISUAL</div>
      <div class="dept-badge" id="dept2badge">AGUARDANDO</div>
      <div class="dept-line"></div>
    </div>
    <div id="ag4wrap"></div>
    <div id="ag5wrap"></div>
  </div>

  <!-- COPY OUTPUT -->
  <div class="out-copy" id="outCopy">
    <div class="out-lbl gold">// COPY APROVADA PELO SQUAD</div>
    <div class="out-titulo" id="outTitulo"></div>
    <div class="out-sub" id="outSub"></div>
    <div class="leg-sep">
      <div class="leg-lbl">LEGENDA INSTAGRAM</div>
      <div class="leg-txt" id="outLeg"></div>
      <button class="cp-btn" onclick="cp('outLeg',this)">‚éò Copiar legenda</button>
    </div>
  </div>

  <!-- PROMPT OUTPUT -->
  <div class="out-prompt" id="outPrompt">
    <div class="out-lbl grn">// PROMPT VISUAL APROVADO</div>
    <div class="out-prompt-txt" id="outPromptTxt"></div>
    <button class="cp-btn" onclick="cp('outPromptTxt',this)">‚éò Copiar prompt</button>
  </div>

  <button class="btn-arte" id="btnArte" onclick="abrirModal()">üé® GERAR ARTE FINAL</button>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-inner">
    <div class="modal-hdr">
      <div class="modal-t">ARTE <em>FINAL</em></div>
      <button class="modal-x" onclick="fecharModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="steps-log" id="stLog"></div>
      <div class="modal-status" id="mStatus">Aguardando...</div>
      <div class="prev-wrap" id="prevWrap">
        <div class="prev-spin" id="prevSpin">
          <div class="spinner"></div>
          <div class="spin-txt" id="spinTxt">GERANDO IMAGEM...</div>
        </div>
        <div class="prev-ratio" id="prevRatio">
          <div class="prev-inner" id="prevInner"></div>
        </div>
      </div>
      <button class="btn-dl" id="btnDl" onclick="baixar()" disabled>‚¨á BAIXAR PNG</button>
    </div>
  </div>
</div>

<div id="RT"></div>

<script>
(function(){
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var KEY='', MODELO=null, BUSY=false;
var FMT={w:1080,h:1080,label:'Feed 1:1'};
var D={}; // dados da empresa
var R={}; // resultados de cada agente: R[id] = texto

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GEMINI ‚Äî fallback auto
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var MODELS=['gemini-2.0-flash-lite','gemini-1.5-flash','gemini-1.5-flash-8b','gemini-1.5-pro'];

function gemini(prompt,cb){
  if(!KEY){cb('Key n√£o configurada.',null);return;}
  if(MODELO){_req(MODELO,prompt,cb);}else{_chain(0,prompt,cb);}
}
function _chain(i,prompt,cb){
  if(i>=MODELS.length){cb('Nenhum modelo dispon√≠vel para esta key.',null);return;}
  _req(MODELS[i],prompt,function(err,res){
    if(!err){
      if(MODELO!==MODELS[i]){
        MODELO=MODELS[i];
        var b=document.getElementById('mBadge');
        if(b)b.textContent=MODELO.replace('gemini-','').replace('-',' ').toUpperCase();
        toast('Modelo: '+MODELO);
      }
      cb(null,res);
    } else if(/404|NOT_FOUND|no longer|unavailable/i.test(err)){
      _chain(i+1,prompt,cb);
    } else {cb(err,null);}
  });
}
function _req(model,prompt,cb){
  var url='https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+KEY;
  var body=JSON.stringify({contents:[{role:'user',parts:[{text:prompt}]}],generationConfig:{maxOutputTokens:1600,temperature:0.87}});
  var x=new XMLHttpRequest();
  x.open('POST',url,true);x.setRequestHeader('Content-Type','application/json');x.timeout=90000;
  x.onreadystatechange=function(){
    if(x.readyState!==4)return;
    if(x.status===0){cb('Sem conex√£o.',null);return;}
    var d;try{d=JSON.parse(x.responseText);}catch(e){cb('Resposta inv√°lida.',null);return;}
    if(x.status===404){cb('404: '+(d.error&&d.error.message||'NOT_FOUND'),null);return;}
    if(x.status===400){cb('Key inv√°lida: '+(d.error&&d.error.message||'400'),null);return;}
    if(x.status===403){cb('Sem permiss√£o (403).',null);return;}
    if(x.status===429){cb('Limite atingido. Aguarde 1 min.',null);return;}
    if(x.status!==200){cb('Erro '+(d.error&&d.error.message||x.status),null);return;}
    if(d.error){cb('Gemini: '+d.error.message,null);return;}
    var t='';try{t=d.candidates[0].content.parts[0].text;}catch(e){cb('Resposta vazia.',null);return;}
    cb(null,t);
  };
  x.ontimeout=function(){cb('Timeout.',null);};x.onerror=function(){cb('Erro de rede.',null);};
  x.send(body);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KEY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var LS='squad2_key';
function loadKey(){try{var k=localStorage.getItem(LS);if(k&&k.length>10){KEY=k;updKeyUI(true);}}catch(e){}}
window.saveKey=function(){
  var v=document.getElementById('kInp').value.trim();
  if(!v){toast('Cole a API Key!');return;}
  if(!v.startsWith('AIza')){toast('‚ö† Key inv√°lida (deve come√ßar com AIza)');return;}
  KEY=v;MODELO=null;
  try{localStorage.setItem(LS,v);}catch(e){}
  document.getElementById('kInp').value='';
  updKeyUI(true);toast('‚úì Key salva!');
};
window.clearKey=function(){
  KEY='';MODELO=null;
  try{localStorage.removeItem(LS);}catch(e){}
  updKeyUI(false);toast('Key removida');
};
function updKeyUI(ok){
  var s=document.getElementById('kSt'),m=document.getElementById('kMsg'),c=document.getElementById('kClear');
  s.className='ks'+(ok?' ok':'');m.textContent=ok?'Key ativa: '+KEY.substring(0,12)+'...':'Nenhuma key salva';
  c.style.display=ok?'block':'none';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FORMAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.selFmt=function(i,w,h,label){
  [0,1,2].forEach(function(x){document.getElementById('fc'+x).classList.remove('on');});
  document.getElementById('fc'+i).classList.add('on');FMT={w:w,h:h,label:label};
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AGENT DEFINITIONS
   6 agents in 3 departments
   Each department: [creator, reviewer]
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var AGENTS=[

  /* ‚îÄ‚îÄ DEPT 1: ESTRAT√âGIA ‚îÄ‚îÄ */
  {
    id:'e1', dept:0, wrap:'ag0wrap',
    role:'creator', ico:'üß†',
    name:'ESTRATEGISTA',
    desc:'Analisa a empresa e cria a premissa central',
    prompt:function(){
      return 'Voc√™ √© o melhor Estrategista de publicidade e marketing do Brasil.\n'+
      'Analise a empresa e crie UMA PREMISSA CENTRAL PODEROSA para um post no Instagram.\n'+
      'A premissa √© o insight que vai mover toda a cria√ß√£o.\nResponda em portugu√™s. Use **negrito** nos t√≠tulos.\n\n'+
      '=== EMPRESA ===\nNome: '+D.nome+'\nNicho: '+D.nicho+'\nSobre: '+D.empresa+
      '\nAbordagem: '+D.abordagem+'\nTom: '+D.tom+'\nFormato: '+FMT.label+'\n\n'+
      '**AN√ÅLISE DO P√öBLICO**\nQuem √©? Qual dor mais profunda? O que deseja secretamente?\n\n'+
      '**INSIGHT DE OURO**\nA descoberta n√£o-√≥bvia sobre este nicho que tornar√° este post √∫nico.\n\n'+
      '**PREMISSA CENTRAL**\nUMA frase ‚Äî a grande ideia. Algo que para o scroll.\n'+
      'Deve ser surpreendente, espec√≠fica, humana e conectada √† dor ou desejo do p√∫blico.\n\n'+
      '**ESTRAT√âGIA DE IMPACTO**\nPor que esta premissa vai funcionar? Qual gatilho psicol√≥gico aciona?\n\n'+
      '**ELEMENTOS SUGERIDOS PARA O CARD**\nBadge/selo, linha de eyebrow, dire√ß√£o do headline, CTA.';
    }
  },
  {
    id:'e2', dept:0, wrap:'ag1wrap',
    role:'reviewer', ico:'üéØ',
    name:'ESTRATEGISTA S√äNIOR',
    desc:'Analisa, refina e aprova a premissa para seguir',
    prompt:function(){
      return 'Voc√™ √© o Estrategista S√™nior mais experiente do mundo ‚Äî j√° trabalhou nas maiores ag√™ncias globais.\n'+
      'Recebeu a premissa criada pelo Estrategista Junior. Sua miss√£o:\n'+
      '1. Analisar criticamente o que foi criado\n'+
      '2. Identificar pontos fracos e oportunidades perdidas\n'+
      '3. Refinar e elevar a premissa ao n√≠vel m√°ximo\n'+
      '4. Aprovar a vers√£o final para o Copy\nResponda em portugu√™s.\n\n'+
      '=== CONTEXTO DA EMPRESA ===\nNome: '+D.nome+' | Nicho: '+D.nicho+' | Tom: '+D.tom+'\n\n'+
      '=== PREMISSA DO ESTRATEGISTA ===\n'+(R.e1||'').substring(0,700)+'\n\n'+
      '**AN√ÅLISE CR√çTICA**\nO que est√° forte? O que est√° fraco ou gen√©rico?\n\n'+
      '**REFINAMENTO**\nA vers√£o melhorada e mais poderosa da premissa.\n'+
      'Corrija, aprofunde, torne mais espec√≠fica e emocionalmente conectada.\n\n'+
      '**PREMISSA FINAL APROVADA**\nA frase definitiva ‚Äî clara, poderosa, √∫nica. UMA frase.\n\n'+
      '**BRIEFING PARA O COPY**\nInstru√ß√µes precisas do que o Copywriter deve criar baseado nesta premissa.\n'+
      'Inclua: dire√ß√£o emocional, gatilhos a usar, o que evitar.';
    }
  },

  /* ‚îÄ‚îÄ DEPT 2: COPY ‚îÄ‚îÄ */
  {
    id:'c1', dept:1, wrap:'ag2wrap',
    role:'creator', ico:'‚úçÔ∏è',
    name:'COPYWRITER',
    desc:'Transforma a premissa em t√≠tulo, subt√≠tulo e legenda',
    prompt:function(){
      return 'Voc√™ √© o melhor Copywriter de publicidade do Brasil, especialista em Instagram e resposta direta.\n'+
      'Pegue a premissa aprovada e crie a copy perfeita para o card visual.\nResponda em portugu√™s.\n\n'+
      '=== BRIEFING DO ESTRATEGISTA S√äNIOR ===\n'+(R.e2||'').substring(0,700)+'\n\n'+
      'Empresa: '+D.nome+' | Tom: '+D.tom+' | Formato: '+FMT.label+'\n\n'+
      'CRIE EXATAMENTE NESTE FORMATO:\n\n'+
      '**TITULO**\n[T√≠tulo principal do card. MAI√öSCULO. M√°x 6 palavras. Para o scroll. Irresist√≠vel.]\n\n'+
      '**SUBTITULO**\n[Complementa o t√≠tulo. M√°x 14 palavras. Aprofunda sem repetir. Gera desejo ou curiosidade.]\n\n'+
      '**LEGENDA**\n'+
      '[Legenda completa para Instagram:\n'+
      'Linha 1: Hook devastador (antes do "ver mais", m√°x 125 chars)\n'+
      'Par√°grafos: 3-4 blocos curtos com emojis, storytelling ou benef√≠cio direto\n'+
      'Pen√∫ltimo: CTA claro e espec√≠fico\n'+
      '√öltimo: 20-25 hashtags relevantes]\n\n'+
      '**RACIOC√çNIO**\n[Explique os gatilhos psicol√≥gicos usados em cada pe√ßa]';
    }
  },
  {
    id:'c2', dept:1, wrap:'ag3wrap',
    role:'reviewer', ico:'üí°',
    name:'COPY DIRECTOR',
    desc:'Avalia, refina e aprova o copy para o layout',
    prompt:function(){
      return 'Voc√™ √© o Copy Director ‚Äî o profissional de copy mais exigente e experiente do mundo.\n'+
      'Avaliou campanhas para Nike, Apple, Natura, Nubank. Tem olho cl√≠nico para o que funciona de verdade.\n'+
      'Sua miss√£o: analisar o copy criado, refinar cada pe√ßa e entregar a vers√£o final aprovada.\nResponda em portugu√™s.\n\n'+
      '=== EMPRESA ===\nNome: '+D.nome+' | Tom: '+D.tom+'\n\n'+
      '=== COPY DO COPYWRITER ===\n'+(R.c1||'').substring(0,700)+'\n\n'+
      '**AN√ÅLISE CR√çTICA**\nAvalie t√≠tulo, subt√≠tulo e legenda. O que est√° forte? O que est√° fraco?\n\n'+
      '**T√çTULO REFINADO**\n[Vers√£o final melhorada do t√≠tulo ‚Äî MAI√öSCULO]\n\n'+
      '**SUBT√çTULO REFINADO**\n[Vers√£o final melhorada do subt√≠tulo]\n\n'+
      '**LEGENDA REFINADA**\n[Vers√£o final completa da legenda com hook, corpo, CTA e hashtags]\n\n'+
      '**APROVA√á√ÉO**\n[Veredicto final e instru√ß√µes para o Diretor Visual]';
    }
  },

  /* ‚îÄ‚îÄ DEPT 3: VISUAL ‚îÄ‚îÄ */
  {
    id:'v1', dept:2, wrap:'ag4wrap',
    role:'creator', ico:'üé¨',
    name:'DIR. FOTOGRAFIA + ARTE',
    desc:'Cria o prompt da imagem e o sistema visual do card',
    prompt:function(){
      return 'Voc√™ √© simultaneamente o maior Diretor de Fotografia E Diretor de Arte do mundo.\n'+
      'Vai criar: (1) o prompt perfeito para gerar a imagem de fundo via IA, e (2) o sistema de design do card.\n'+
      'A imagem precisa: impacto visual imediato + √°rea inferior mais escura/limpa para o texto.\nResponda em portugu√™s. PROMPT em ingl√™s.\n\n'+
      '=== COPY APROVADA ===\n'+
      'T√≠tulo: '+(R.titulo_final||D.nome)+'\nSubt√≠tulo: '+(R.sub_final||'')+'\n'+
      'Premissa: '+(R.e2||'').substring(0,300)+'\n\n'+
      'Empresa: '+D.nome+' | Nicho: '+D.nicho+' | Tom: '+D.tom+' | Formato: '+FMT.w+'√ó'+FMT.h+'px\n\n'+
      '**CONCEITO VISUAL**\nO que a imagem vai mostrar e por que refor√ßa a mensagem?\n\n'+
      '**ILUMINA√á√ÉO E MOOD**\nComo a luz cria a atmosfera certa?\n\n'+
      '**SISTEMA DE CORES DO CARD**\nDefina HEX para cada elemento:\n'+
      '- Cor de destaque: #HEX\n- T√≠tulo: #HEX\n- Subt√≠tulo: rgba\n'+
      '- Overlay in√≠cio/fim: rgba, rgba\n- Badge/CTA: #HEX\n\n'+
      '**TIPOGRAFIA**\nFonte do t√≠tulo (Google Fonts): [nome]\nFonte do subt√≠tulo: [nome]\n\n'+
      'CARD_STYLE_START\n'+
      '{"hlColor":"#FFFFFF","hlFont":"Bebas Neue","hlSize":'+(FMT.h>1500?120:FMT.h>1100?90:74)+',"stColor":"rgba(255,255,255,0.82)","stFont":"DM Sans","badgeBg":"#e8390e","badgeFg":"#FFFFFF","acc":"#c9a84c","ov1":"rgba(0,0,0,0.0)","ov2":"rgba(0,0,0,0.88)","decor":"rgba(255,255,255,0.03)"}\n'+
      'CARD_STYLE_END\n\n'+
      '**PROMPT DE IMAGEM** (em ingl√™s)\n[Prompt detalhado: sujeito, ambiente, luz, mood, estilo, qualidade. '+
      '√Årea inferior com poucos elementos para caber o texto sobreposto. '+
      'Termine com: photorealistic, 8k, cinematic, no text, no watermark, professional photography]';
    }
  },
  {
    id:'v2', dept:2, wrap:'ag5wrap',
    role:'reviewer', ico:'üèÜ',
    name:'DIRETOR CRIATIVO EXECUTIVO',
    desc:'Revis√£o final ‚Äî refina o prompt e aprova o layout',
    prompt:function(){
      return 'Voc√™ √© o Diretor Criativo Executivo ‚Äî o olhar mais exigente da ag√™ncia.\n'+
      'J√° dirigiu campanhas premiadas em Cannes. Aprova ou reprova tudo antes de ir para produ√ß√£o.\n'+
      'Sua miss√£o: analisar a dire√ß√£o visual criada, refinar o prompt de imagem e entregar a vers√£o definitiva.\nResponda em portugu√™s. PROMPT FINAL em ingl√™s.\n\n'+
      '=== CONTEXTO ===\nEmpresa: '+D.nome+' | Tom: '+D.tom+' | '+FMT.w+'√ó'+FMT.h+'px\n'+
      'T√≠tulo: '+(R.titulo_final||'')+' | Subt√≠tulo: '+(R.sub_final||'')+'\n\n'+
      '=== DIRE√á√ÉO DO DIR. FOTOGRAFIA + ARTE ===\n'+(R.v1||'').substring(0,700)+'\n\n'+
      '**AN√ÅLISE CR√çTICA**\nO que est√° certo? O que precisa melhorar no conceito e no prompt?\n\n'+
      '**CARD_STYLE REFINADO**\n[Se quiser ajustar as cores/fontes, reescreva o JSON abaixo]\n'+
      'CARD_STYLE_START\n'+
      '{"hlColor":"#FFFFFF","hlFont":"Bebas Neue","hlSize":'+(FMT.h>1500?120:FMT.h>1100?90:74)+',"stColor":"rgba(255,255,255,0.82)","stFont":"DM Sans","badgeBg":"#e8390e","badgeFg":"#FFFFFF","acc":"#c9a84c","ov1":"rgba(0,0,0,0.0)","ov2":"rgba(0,0,0,0.88)","decor":"rgba(255,255,255,0.03)"}\n'+
      'CARD_STYLE_END\n\n'+
      '**PROMPT FINAL APROVADO** (em ingl√™s)\n[Vers√£o definitiva do prompt ‚Äî melhorada, mais espec√≠fica, mais poderosa. '+
      'Este ser√° o prompt usado para gerar a imagem real. Seja detalhado: composi√ß√£o, luz, cor, estilo, atmosfera. '+
      'Termine com: photorealistic, 8k, cinematic, no text, no watermark]\n\n'+
      '**APROVA√á√ÉO FINAL**\nVeredicto + instru√ß√µes finais para produ√ß√£o do card.';
    }
  }

]; // end AGENTS

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILD AGENT HTML
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildAg(ag){
  var roleLabel=ag.role==='creator'?'CRIA√á√ÉO':'REVIS√ÉO & APROVA√á√ÉO';
  return '<div class="ag '+ag.role+'" id="el_'+ag.id+'">'+
    '<div class="ag-stripe"></div>'+
    '<div class="ag-top" onclick="togAg(\''+ag.id+'\')">'+
      '<div class="ag-ico">'+ag.ico+'</div>'+
      '<div class="ag-meta">'+
        '<div class="ag-role-tag">'+roleLabel+'</div>'+
        '<div class="ag-name">'+ag.name+'</div>'+
        '<div class="ag-desc">'+ag.desc+'</div>'+
      '</div>'+
      '<div class="ag-tag" id="tag_'+ag.id+'">IDLE</div>'+
    '</div>'+
    '<div class="ag-body" id="bd_'+ag.id+'">'+
      '<div class="ag-txt" id="tx_'+ag.id+'"></div>'+
    '</div>'+
  '</div>';
}

(function(){
  AGENTS.forEach(function(ag){
    document.getElementById(ag.wrap).innerHTML=buildAg(ag);
  });
})();

window.togAg=function(id){document.getElementById('bd_'+id).classList.toggle('open');};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PIPELINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var TOTAL=AGENTS.length;
var cur=0;

window.iniciar=function(){
  if(BUSY)return;
  escErr();
  if(!KEY){showErr('Configure e salve sua Gemini API Key primeiro.');return;}
  var empresa=document.getElementById('fEmpresa').value.trim();
  var abordagem=document.getElementById('fAbordagem').value.trim();
  if(!empresa||!abordagem){toast('‚ö† Preencha os campos da empresa!');return;}

  D={
    nome:document.getElementById('fNome').value.trim()||'Empresa',
    nicho:document.getElementById('fNicho').value.trim()||'geral',
    empresa:empresa,
    abordagem:abordagem,
    tom:document.getElementById('fTom').value||'Moderno e Direto'
  };

  BUSY=true;cur=0;R={};
  resetUI();
  document.getElementById('btnGo').disabled=true;
  document.getElementById('btnGo').textContent='‚è≥ SQUADS EM A√á√ÉO...';
  document.getElementById('progWrap').classList.add('on');
  document.getElementById('btnArte').classList.remove('on');

  rodar(0);
};

function rodar(i){
  if(i>=AGENTS.length){
    // Done!
    setProg(AGENTS.length);
    BUSY=false;
    document.getElementById('btnGo').disabled=false;
    document.getElementById('btnGo').textContent='‚ñ∂ ACIONAR SQUADS';
    document.getElementById('btnArte').classList.add('on');
    toast('‚úì Todos os squads conclu√≠dos!');
    document.getElementById('btnArte').scrollIntoView({behavior:'smooth',block:'center'});
    return;
  }

  var ag=AGENTS[i];
  setProg(i);

  // UI: running
  var el=document.getElementById('el_'+ag.id);
  el.classList.add('run');el.classList.remove('done','refine');
  document.getElementById('tag_'+ag.id).textContent='...';
  document.getElementById('bd_'+ag.id).classList.add('open');
  document.getElementById('tx_'+ag.id).innerHTML='<div class="dots"><span></span><span></span><span></span></div>';
  el.scrollIntoView({behavior:'smooth',block:'nearest'});

  // Mark dept as active
  var db=document.getElementById('dept'+ag.dept+'badge');
  db.textContent='EM A√á√ÉO';db.className='dept-badge';

  gemini(ag.prompt(),function(err,res){
    var elEl=document.getElementById('el_'+ag.id);
    elEl.classList.remove('run');

    if(err){
      elEl.classList.add('done');
      document.getElementById('tag_'+ag.id).textContent='‚ö†';
      document.getElementById('tx_'+ag.id).innerHTML='<span style="color:#ff8060">'+esc(err)+'</span>';
      R[ag.id]='';
      showErr('Erro em '+ag.name+': '+err);
    } else {
      // Reviewer gets gold color
      elEl.classList.add(ag.role==='reviewer'?'done refine':'done');
      document.getElementById('tag_'+ag.id).textContent=ag.role==='reviewer'?'‚úì APR':'‚úì';
      document.getElementById('tx_'+ag.id).innerHTML=
        (ag.role==='reviewer'?'<div class="approved">‚úì APROVADO E REFINADO</div><br>':'')+
        renderTxt(res.substring(0,500)+(res.length>500?'‚Ä¶':''));
      R[ag.id]=res;
      processResult(ag.id,res);
    }

    // Mark dept done if reviewer finished
    if(ag.role==='reviewer'){
      var db2=document.getElementById('dept'+ag.dept+'badge');
      db2.textContent='APROVADO ‚úì';db2.className='dept-badge done';
    }

    setTimeout(function(){rodar(i+1);},250);
  });
}

function processResult(id,txt){
  // After copy reviewer (c2) ‚Äî extract final copy
  if(id==='c2'){
    var tit=extract(txt,'T√çTULO REFINADO')||extract(txt,'TITULO REFINADO')||extract(R.c1||'','TITULO');
    var sub=extract(txt,'SUBT√çTULO REFINADO')||extract(txt,'SUBTITULO REFINADO')||extract(R.c1||'','SUBTITULO');
    var leg=extractBlock(txt,'LEGENDA REFINADA','APROVA√á√ÉO')||extractBlock(R.c1||'','LEGENDA','RACIOC√çNIO');
    R.titulo_final=tit||D.nome.toUpperCase();
    R.sub_final=sub||'';
    R.leg_final=leg||'';
    document.getElementById('outTitulo').textContent=R.titulo_final;
    document.getElementById('outSub').textContent=R.sub_final;
    document.getElementById('outLeg').textContent=R.leg_final.replace(/\*\*/g,'').trim();
    document.getElementById('outCopy').classList.add('on');
  }
  // After visual reviewer (v2) ‚Äî extract final prompt + style
  if(id==='v2'){
    // Try prompt from reviewer first, fallback to creator
    var pm=txt.match(/\*\*PROMPT FINAL APROVADO\*\*[^\n]*\n([\s\S]+?)(?:\n\n\*\*|$)/i);
    if(!pm) pm=txt.match(/\*\*PROMPT[^*]*\*\*[^\n]*\n([\s\S]+?)(?:\n\n\*\*|$)/i);
    R.imgPrompt=pm?pm[1].trim().replace(/^```\w*\n?/,'').replace(/```$/,'').trim():'';
    if(!R.imgPrompt||R.imgPrompt.length<20){
      // fallback to creator
      var pm2=(R.v1||'').match(/\*\*PROMPT DE IMAGEM\*\*[^\n]*\n([\s\S]+?)(?:\n\n\*\*|$)/i);
      R.imgPrompt=pm2?pm2[1].trim():'';
    }
    if(!R.imgPrompt||R.imgPrompt.length<20){
      R.imgPrompt=D.nicho+' professional cinematic atmosphere, dramatic lighting, 8k, no text, no watermark';
    }

    // Extract style ‚Äî try reviewer first then creator
    R.cardStyle={};
    var sources=[txt, R.v1||''];
    for(var si=0;si<sources.length;si++){
      var sm=sources[si].match(/CARD_STYLE_START\s*([\s\S]*?)\s*CARD_STYLE_END/);
      if(sm){try{R.cardStyle=JSON.parse(sm[1].trim());break;}catch(e){}}
    }

    document.getElementById('outPromptTxt').textContent=R.imgPrompt;
    document.getElementById('outPrompt').classList.add('on');
  }
}

function extract(txt,label){
  var rx=new RegExp('\\*\\*'+label+'\\*\\*\\n([^\\n\\*\\[]+)','i');
  var m=txt.match(rx);
  return m?m[1].trim().replace(/^\[|\]$/g,'').replace(/^["'](.*)["']$/,'$1'):'';
}
function extractBlock(txt,start,end){
  var rx=new RegExp('\\*\\*'+start+'\\*\\*[^\\n]*\\n([\\s\\S]+?)(?:\\n\\*\\*'+end+'|$)','i');
  var m=txt.match(rx);return m?m[1].trim():'';
}

function setProg(cur){
  var p=Math.round(cur/TOTAL*100);
  document.getElementById('progFill').style.width=p+'%';
  document.getElementById('progPct').textContent=p+'%';
  document.getElementById('progLbl').textContent=
    cur<TOTAL?AGENTS[cur].name+' em a√ß√£o...':'‚úì Pipeline conclu√≠do!';
}

function resetUI(){
  AGENTS.forEach(function(ag){
    var el=document.getElementById('el_'+ag.id);
    el.classList.remove('run','done','refine');
    document.getElementById('tag_'+ag.id).textContent='IDLE';
    document.getElementById('bd_'+ag.id).classList.remove('open');
    document.getElementById('tx_'+ag.id).innerHTML='';
  });
  [0,1,2].forEach(function(i){
    var db=document.getElementById('dept'+i+'badge');
    db.textContent='AGUARDANDO';db.className='dept-badge';
  });
  document.getElementById('outCopy').classList.remove('on');
  document.getElementById('outPrompt').classList.remove('on');
  document.getElementById('RT').innerHTML='';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ARTE FINAL ‚Äî NANO BANANA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var artSt=[];

window.abrirModal=function(){
  document.getElementById('modal').classList.add('open');
  document.getElementById('prevSpin').classList.remove('gone');
  document.getElementById('spinTxt').textContent='GERANDO IMAGEM...';
  document.getElementById('mStatus').className='modal-status';
  document.getElementById('mStatus').textContent='Gerando imagem com Pollinations AI (Flux)...';
  document.getElementById('btnDl').disabled=true;
  document.getElementById('stLog').innerHTML='';
  document.getElementById('prevInner').innerHTML='';
  document.getElementById('btnArte').disabled=true;
  document.getElementById('prevRatio').style.paddingTop=(FMT.h/FMT.w*100)+'%';
  document.getElementById('RT').style.cssText=
    'position:fixed;left:-39999px;top:0;width:'+FMT.w+'px;height:'+FMT.h+'px;overflow:hidden;z-index:-100;pointer-events:none;';
  artSt=[];
  gerarArte();
};

function addSt(txt,s){
  if(artSt.length>0&&!artSt[artSt.length-1].s) artSt[artSt.length-1].s='ok';
  if(s==='active'||!s) artSt.push({t:txt,s:'active'});
  renderSt();
  document.getElementById('spinTxt').textContent=txt.substring(0,26).toUpperCase();
}
function finSt(s){if(artSt.length>0)artSt[artSt.length-1].s=s||'ok';renderSt();}
function renderSt(){
  document.getElementById('stLog').innerHTML=artSt.map(function(s){
    var ic=s.s==='ok'?'‚úì':s.s==='err'?'‚úï':'‚óè';
    return '<div class="step-item '+s.s+'"><span>'+ic+'</span>'+esc(s.t)+'</div>';
  }).join('');
}

function gerarArte(){
  addSt('Gerando imagem com Pollinations AI (Flux)...');
  var seed=Math.floor(Math.random()*99999);
  var p=(R.imgPrompt||D.nicho+' cinematic professional, 8k, no text').substring(0,380);
  var url='https://image.pollinations.ai/prompt/'+encodeURIComponent(p)+
    '?width='+FMT.w+'&height='+FMT.h+'&seed='+seed+'&model=flux&nologo=true&enhance=true';
  var img=new Image();img.crossOrigin='anonymous';
  var t=setTimeout(function(){finSt('ok');addSt('Timeout ‚Äî usando gradiente...');montarCard(null);},22000);
  img.onload=function(){clearTimeout(t);finSt('ok');addSt('Imagem gerada! Montando layout...');montarCard(img);};
  img.onerror=function(){clearTimeout(t);finSt('ok');addSt('Erro ‚Äî usando gradiente...');montarCard(null);};
  img.src=url;
}

function montarCard(imgEl){
  var cs=R.cardStyle||{};
  var C={
    hlColor:cs.hlColor||'#FFFFFF',hlFont:cs.hlFont||'Bebas Neue',
    hlSize:parseInt(cs.hlSize)||(FMT.h>1500?120:FMT.h>1100?90:74),
    stColor:cs.stColor||'rgba(255,255,255,0.82)',stFont:cs.stFont||'DM Sans',
    badgeBg:cs.badgeBg||'#e8390e',badgeFg:cs.badgeFg||'#FFFFFF',
    acc:cs.acc||'#c9a84c',
    ov1:cs.ov1||'rgba(0,0,0,0.0)',ov2:cs.ov2||'rgba(0,0,0,0.88)',
    decor:cs.decor||'rgba(255,255,255,0.03)'
  };

  var W=FMT.w,H=FMT.h,pad=Math.round(W*0.07),hl=C.hlSize;
  var titulo=(R.titulo_final||D.nome).toUpperCase();
  var sub=R.sub_final||'';
  var brand='@'+D.nome.toLowerCase().replace(/\s+/g,'');
  var nicho=D.nicho.split(' ').slice(0,2).join(' ').toUpperCase();

  function mk(tag,css,txt){var d=document.createElement(tag);d.style.cssText=css;if(txt!==undefined)d.textContent=txt;return d;}

  var card=mk('div','position:relative;width:'+W+'px;height:'+H+'px;overflow:hidden;font-family:sans-serif;background:#080808;');

  // BG
  if(imgEl){
    var cv=document.createElement('canvas');cv.width=W;cv.height=H;
    var ctx=cv.getContext('2d');
    var iR=imgEl.naturalWidth/imgEl.naturalHeight,cR=W/H,dw,dh,dx,dy;
    if(iR>cR){dh=H;dw=H*iR;dx=(W-dw)/2;dy=0;}else{dw=W;dh=W/iR;dx=0;dy=(H-dh)/2;}
    ctx.drawImage(imgEl,dx,dy,dw,dh);
    card.appendChild(mk('div','position:absolute;inset:0;background-image:url('+cv.toDataURL('image/jpeg',.92)+');background-size:cover;background-position:center;'));
  } else {
    card.appendChild(mk('div','position:absolute;inset:0;background:linear-gradient(145deg,#090914 0%,#120820 40%,#080d14 100%);'));
    // glow
    card.appendChild(mk('div','position:absolute;width:'+Math.round(W*.75)+'px;height:'+Math.round(W*.75)+'px;border-radius:50%;left:'+Math.round(W*.1)+'px;top:'+Math.round(H*-.15)+'px;background:radial-gradient(circle,'+C.acc+'33 0%,transparent 70%);filter:blur('+Math.round(W*.09)+'px);'));
  }

  // Overlay bottom-heavy
  card.appendChild(mk('div','position:absolute;inset:0;background:linear-gradient(to top,'+C.ov2+' 0%,rgba(0,0,0,0.5) 42%,'+C.ov1+' 100%);'));
  // Vinheta lateral
  card.appendChild(mk('div','position:absolute;inset:0;background:linear-gradient(to right,rgba(0,0,0,.4) 0%,transparent 35%,transparent 65%,rgba(0,0,0,.25) 100%);'));

  // Accent top line
  card.appendChild(mk('div','position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,'+C.acc+','+C.badgeBg+',transparent);'));

  // SVG decor
  var NS='http://www.w3.org/2000/svg';
  var svg=document.createElementNS(NS,'svg');
  svg.setAttribute('viewBox','0 0 '+W+' '+H);
  svg.style.cssText='position:absolute;inset:0;width:100%;height:100%;pointer-events:none;';
  function circ(cx,cy,r,fill){var c=document.createElementNS(NS,'circle');c.setAttribute('cx',cx);c.setAttribute('cy',cy);c.setAttribute('r',r);c.setAttribute('fill',fill);return c;}
  svg.appendChild(circ(Math.round(W*.84),Math.round(H*.10),Math.round(W*.22),C.decor));
  svg.appendChild(circ(Math.round(W*.08),Math.round(H*.36),Math.round(W*.09),C.decor));
  // diagonal accent line
  var ln=document.createElementNS(NS,'line');
  ln.setAttribute('x1','0');ln.setAttribute('y1',Math.round(H*.52));
  ln.setAttribute('x2',Math.round(W*.45));ln.setAttribute('y2',Math.round(H*.38));
  ln.setAttribute('stroke',C.acc);ln.setAttribute('stroke-opacity','0.15');ln.setAttribute('stroke-width','1.5');
  svg.appendChild(ln);
  card.appendChild(svg);

  // TOP: brand
  card.appendChild(mk('div','position:absolute;top:'+pad+'px;right:'+pad+'px;font-family:Space Mono,monospace;font-size:'+Math.round(hl*.11)+'px;color:rgba(255,255,255,.28);letter-spacing:2px;z-index:10;',brand));

  // TOP: nicho badge
  var bfs=Math.round(hl*.14);
  card.appendChild(mk('div','position:absolute;top:'+pad+'px;left:'+pad+'px;background:'+C.badgeBg+';color:'+C.badgeFg+';font-family:Space Mono,monospace;font-size:'+bfs+'px;letter-spacing:2px;padding:'+Math.round(bfs*.5)+'px '+Math.round(bfs*1.1)+'px;border-radius:4px;text-transform:uppercase;z-index:10;',nicho));

  // CONTENT BLOCK
  var bottom=Math.round(pad*1.7);
  var cont=mk('div','position:absolute;bottom:'+bottom+'px;left:'+pad+'px;right:'+pad+'px;z-index:10;');

  // Eyebrow
  cont.appendChild(mk('div','font-family:Space Mono,monospace;font-size:'+Math.round(hl*.155)+'px;color:'+C.acc+';letter-spacing:4px;text-transform:uppercase;margin-bottom:'+Math.round(hl*.11)+'px;',D.nome.toUpperCase()));

  // Accent rule
  cont.appendChild(mk('div','width:'+Math.round(W*.055)+'px;height:2px;background:'+C.acc+';margin-bottom:'+Math.round(hl*.19)+'px;border-radius:1px;'));

  // T√≠tulo
  cont.appendChild(mk('div','font-family:\''+C.hlFont+'\',Impact,Haettenschweiler,sans-serif;font-weight:900;font-size:'+hl+'px;color:'+C.hlColor+';line-height:0.93;text-transform:uppercase;letter-spacing:-1px;margin-bottom:'+Math.round(hl*.16)+'px;text-shadow:0 4px 40px rgba(0,0,0,.65);',titulo));

  // Subt√≠tulo
  if(sub){
    cont.appendChild(mk('div','font-family:\''+C.stFont+'\',sans-serif;font-size:'+Math.round(hl*.215)+'px;color:'+C.stColor+';line-height:1.45;margin-bottom:'+Math.round(hl*.26)+'px;max-width:88%;',sub));
  }

  // CTA row
  var cta=mk('div','display:flex;align-items:center;gap:'+Math.round(hl*.18)+'px;');
  cta.appendChild(mk('div','display:inline-flex;align-items:center;font-family:Space Mono,monospace;font-size:'+Math.round(hl*.148)+'px;color:'+C.badgeFg+';background:'+C.badgeBg+';padding:'+Math.round(hl*.2)+'px '+Math.round(hl*.55)+'px;border-radius:4px;letter-spacing:2px;text-transform:uppercase;','SAIBA MAIS ‚Üí'));
  cta.appendChild(mk('div','flex:1;height:1px;background:rgba(255,255,255,.12);'));
  cont.appendChild(cta);
  card.appendChild(cont);

  // Bottom accent
  card.appendChild(mk('div','position:absolute;bottom:0;left:0;right:0;height:4px;background:linear-gradient(90deg,'+C.acc+','+C.badgeBg+' 60%,transparent);'));

  // RENDER
  var rt=document.getElementById('RT');rt.innerHTML='';rt.appendChild(card);

  setTimeout(function(){
    var wW=document.getElementById('prevWrap').offsetWidth;
    var sc=wW/W;
    var inner=document.getElementById('prevInner');
    inner.innerHTML='';
    var sw=mk('div','position:absolute;top:0;left:0;width:'+W+'px;height:'+H+'px;transform:scale('+sc+');transform-origin:top left;');
    sw.appendChild(card.cloneNode(true));
    inner.appendChild(sw);
    finSt('ok');
    document.getElementById('prevSpin').classList.add('gone');
    document.getElementById('mStatus').className='modal-status ok';
    document.getElementById('mStatus').textContent='‚úì Arte final aprovada! Verifique e baixe abaixo.';
    document.getElementById('btnDl').disabled=false;
    document.getElementById('btnArte').disabled=false;
  },900);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOWNLOAD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.baixar=function(){
  var btn=document.getElementById('btnDl');
  btn.disabled=true;btn.textContent='‚è≥ CAPTURANDO...';
  var rt=document.getElementById('RT');
  var cardEl=rt.firstElementChild;
  if(!cardEl){toast('Gere a arte primeiro!');btn.disabled=false;btn.textContent='‚¨á BAIXAR PNG';return;}
  rt.style.left='0';rt.style.zIndex='9999';
  setTimeout(function(){
    html2canvas(cardEl,{width:FMT.w,height:FMT.h,scale:1,useCORS:true,allowTaint:true,backgroundColor:null,logging:false})
    .then(function(canvas){
      rt.style.left='-39999px';rt.style.zIndex='-100';
      canvas.toBlob(function(blob){
        var url=URL.createObjectURL(blob);
        var a=document.createElement('a');a.href=url;
        a.download=D.nome.replace(/\s+/g,'-').toLowerCase()+'-'+FMT.w+'x'+FMT.h+'.png';
        document.body.appendChild(a);a.click();document.body.removeChild(a);
        setTimeout(function(){URL.revokeObjectURL(url);},3000);
        btn.textContent='‚úì BAIXADO!';toast('‚úì PNG salvo!');
        setTimeout(function(){btn.disabled=false;btn.textContent='‚¨á BAIXAR PNG';},3000);
      },'image/png',1.0);
    }).catch(function(){
      rt.style.left='-39999px';rt.style.zIndex='-100';
      var h='<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{margin:0;padding:0}body{width:'+FMT.w+'px;height:'+FMT.h+'px;overflow:hidden}</style></head><body>'+rt.innerHTML+'</body></html>';
      var b=new Blob([h],{type:'text/html'});var u=URL.createObjectURL(b);
      var a=document.createElement('a');a.href=u;a.download=D.nome.replace(/\s+/g,'-').toLowerCase()+'.html';
      document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);
      btn.disabled=false;btn.textContent='‚¨á BAIXAR PNG';
      toast('Salvo como HTML ‚Äî abra no Chrome para screenshot');
    });
  },500);
};

window.fecharModal=function(){document.getElementById('modal').classList.remove('open');document.getElementById('btnArte').disabled=false;};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.cp=function(id,btn){
  var t=document.getElementById(id).textContent;
  function ok(){var o=btn.textContent;btn.textContent='‚úì Copiado!';setTimeout(function(){btn.textContent=o;},2000);}
  if(navigator.clipboard){navigator.clipboard.writeText(t).then(ok);}
  else{var ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);ok();}
};
function renderTxt(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(msg){var t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(function(){if(t.parentNode)t.parentNode.removeChild(t);},2800);}
function showErr(msg){var e=document.getElementById('errBox');e.textContent='‚ö†Ô∏è '+msg;e.classList.add('on');e.scrollIntoView({behavior:'smooth',block:'center'});}
function escErr(){document.getElementById('errBox').classList.remove('on');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
loadKey();

})();
</script>
</body>
</html>
