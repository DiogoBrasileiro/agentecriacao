<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SQUAD ‚Äî Card Creator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap');

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{font-size:16px}
body{
  background:#0c0c0c;color:#f0f0f0;
  font-family:'Inter',system-ui,sans-serif;
  min-height:100vh;overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}

/* HEADER */
.hdr{
  position:sticky;top:0;z-index:200;
  background:rgba(12,12,12,.97);backdrop-filter:blur(12px);
  border-bottom:1px solid #2a2a2a;
  padding:12px 16px;
  display:flex;align-items:center;justify-content:space-between;
}
.logo{font-family:'Bebas Neue';font-size:20px;letter-spacing:5px}
.logo span{color:#ff3c00}
.live-badge{
  font-family:'Space Mono';font-size:9px;color:#22c55e;
  border:1px solid rgba(34,197,94,.4);border-radius:6px;
  padding:3px 9px;display:flex;align-items:center;gap:5px;
}
.live-badge::before{
  content:'';width:5px;height:5px;border-radius:50%;
  background:#22c55e;animation:blink 2s infinite;flex-shrink:0;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* PAGE WRAPPER */
.page{
  width:100%;max-width:520px;
  margin:0 auto;padding:14px 14px 80px;
}

/* BOX */
.box{
  background:#161616;border:1px solid #2a2a2a;border-radius:14px;
  padding:16px;margin-bottom:12px;
}
.box-lbl{
  font-family:'Space Mono';font-size:9px;letter-spacing:2px;
  color:#ff3c00;text-transform:uppercase;margin-bottom:13px;
  display:flex;align-items:center;gap:8px;
}
.box-lbl::after{content:'';flex:1;height:1px;background:#2a2a2a}

/* KEY BOX */
.key-saved{
  display:flex;align-items:center;gap:8px;
  background:#0d1f14;border:1px solid rgba(34,197,94,.3);
  border-radius:10px;padding:10px 13px;margin-bottom:10px;
  font-size:13px;color:#22c55e;font-family:'Space Mono';
}
.key-saved.hidden{display:none}
.key-saved .ic{font-size:16px;flex-shrink:0}
.key-form{display:flex;gap:8px}
.key-inp{
  flex:1;min-width:0;
  background:#1e1e1e;border:1px solid #2a2a2a;color:#f0f0f0;
  padding:11px 12px;border-radius:10px;
  font-family:'Space Mono';font-size:12px;outline:none;
  transition:border-color .2s;
}
.key-inp:focus{border-color:#38bdf8}
.key-inp.error{border-color:#ef4444;animation:shake .3s}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.btn-key{
  background:#38bdf8;color:#000;border:none;
  padding:11px 16px;border-radius:10px;
  font-family:'Inter';font-size:14px;font-weight:700;
  cursor:pointer;flex-shrink:0;white-space:nowrap;
}
.btn-key:active{opacity:.8}
.btn-key-reset{
  background:transparent;border:none;
  color:#ef4444;font-size:12px;cursor:pointer;
  text-decoration:underline;padding:0;margin-top:6px;display:block;
}
.key-hint{font-size:12px;color:#555;margin-top:7px}
.key-hint a{color:#38bdf8;text-decoration:none}

/* FIELDS */
.field{margin-bottom:11px}
.field:last-child{margin-bottom:0}
.lbl{display:block;font-size:12px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px}
.inp,.sel,.ta{
  display:block;width:100%;
  background:#1e1e1e;border:1px solid #2a2a2a;color:#f0f0f0;
  padding:12px 13px;border-radius:10px;
  font-family:'Inter';font-size:15px;outline:none;
  transition:border-color .2s;appearance:none;-webkit-appearance:none;
}
.inp:focus,.sel:focus,.ta:focus{border-color:#ff3c00}
.sel-w{position:relative}
.sel-w::after{
  content:'‚ñæ';position:absolute;right:13px;top:50%;
  transform:translateY(-50%);color:#555;pointer-events:none;
}
.sel{padding-right:34px}
.sel option{background:#1a1a1a}
.ta{resize:vertical;min-height:80px;line-height:1.5}

/* FORMAT */
.fmt-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.fmt-btn{
  background:#1e1e1e;border:1.5px solid #2a2a2a;border-radius:12px;
  padding:12px 6px;cursor:pointer;text-align:center;
  display:flex;flex-direction:column;align-items:center;gap:7px;
  transition:border-color .15s,background .15s;
}
.fmt-btn.on{border-color:#ff3c00;background:rgba(255,60,0,.08)}
.fmt-thumb{background:#2a2a2a;border:1.5px solid #3a3a3a;border-radius:3px}
.fmt-btn.on .fmt-thumb{border-color:#ff3c00}
.fmt-nm{font-family:'Bebas Neue';font-size:13px;letter-spacing:1px;color:#666}
.fmt-sz{font-family:'Space Mono';font-size:9px;color:#444}
.fmt-btn.on .fmt-nm{color:#ff3c00}

/* BUTTONS */
.btn-go{
  width:100%;padding:17px;margin-bottom:12px;
  background:#ff3c00;color:#fff;border:none;border-radius:14px;
  font-family:'Bebas Neue';font-size:22px;letter-spacing:4px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
  transition:opacity .15s,transform .1s;
}
.btn-go:active{opacity:.85;transform:scale(.98)}
.btn-go:disabled{background:#222;color:#444;cursor:not-allowed;transform:none;opacity:1}

/* PROGRESS */
.prog{display:none;background:#161616;border:1px solid #2a2a2a;border-radius:14px;padding:14px;margin-bottom:12px}
.prog.show{display:block}
.prog-track{height:3px;background:#222;border-radius:2px;overflow:hidden;margin-bottom:7px}
.prog-fill{height:100%;width:0%;background:linear-gradient(90deg,#ff3c00,#ffcc00);transition:width .5s}
.prog-meta{display:flex;justify-content:space-between;font-family:'Space Mono';font-size:10px;color:#555}

/* AGENT */
.agent{
  background:#161616;border:1px solid #2a2a2a;border-radius:12px;
  margin-bottom:8px;overflow:hidden;transition:border-color .3s;
}
.agent.running{border-color:#ff3c00}
.agent.done{border-color:rgba(34,197,94,.4)}
.agent.error{border-color:rgba(239,68,68,.4)}
.agent-hd{display:flex;align-items:center;gap:12px;padding:13px;cursor:pointer;user-select:none}
.agent-ico{
  width:42px;height:42px;border-radius:11px;flex-shrink:0;
  background:#1e1e1e;border:1px solid #2a2a2a;
  display:flex;align-items:center;justify-content:center;font-size:18px;
  transition:background .2s,border-color .2s;
}
.agent.running .agent-ico{background:rgba(255,60,0,.1);border-color:#ff3c00}
.agent.done .agent-ico{background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.4)}
.agent.error .agent-ico{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.4)}
.agent-info{flex:1;min-width:0}
.agent-num{font-family:'Space Mono';font-size:9px;color:#444}
.agent-name{font-family:'Bebas Neue';font-size:16px;letter-spacing:1px;line-height:1.1}
.agent-role{font-size:11px;color:#555;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.agent-tag{font-family:'Space Mono';font-size:9px;padding:4px 8px;border-radius:7px;border:1px solid #2a2a2a;color:#444;flex-shrink:0}
.agent.running .agent-tag{border-color:#ff3c00;color:#ff3c00}
.agent.done .agent-tag{border-color:#22c55e;color:#22c55e}
.agent.error .agent-tag{border-color:#ef4444;color:#ef4444}
.agent-body{display:none;padding:0 13px 13px;border-top:1px solid #222}
.agent-body.open{display:block;padding-top:11px}
.agent-body-txt{font-size:12px;line-height:1.8;color:#aaa;white-space:pre-wrap;word-break:break-word}
.agent-body-txt strong{color:#ffcc00}
.agent-body-txt .err-msg{color:#ef4444;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:10px;margin-top:6px;font-size:11px}

/* DOTS */
.dots{display:flex;gap:4px;padding:10px 0}
.dots span{width:5px;height:5px;border-radius:50%;background:#ff3c00;animation:dot 1.2s infinite}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes dot{0%,100%{opacity:.25;transform:translateY(0)}50%{opacity:1;transform:translateY(-5px)}}

/* OUTPUTS */
.out-box{background:#161616;border:1px solid #2a2a2a;border-radius:12px;margin-bottom:8px;overflow:hidden}
.out-hd{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.out-hd:active{background:#1e1e1e}
.out-title{font-family:'Bebas Neue';font-size:14px;letter-spacing:1px}
.out-body{display:none;padding:0 14px 13px;font-size:12px;line-height:1.8;color:#aaa;white-space:pre-wrap;word-break:break-word;border-top:1px solid #222}
.out-body.open{display:block;padding-top:11px}
.out-body strong{color:#ffcc00}

/* PROMPT / LEGENDA */
.prompt-card{background:#060f0a;border:1px solid rgba(34,197,94,.2);border-radius:12px;padding:14px;margin-bottom:10px;display:none}
.prompt-card.show{display:block}
.prompt-lbl{font-family:'Space Mono';font-size:9px;color:#22c55e;letter-spacing:2px;margin-bottom:8px}
.prompt-txt{font-family:'Space Mono';font-size:11px;color:#5ef0a0;line-height:1.65;word-break:break-all;white-space:pre-wrap}

.leg-card{background:#161616;border:1px solid rgba(255,204,0,.25);border-radius:12px;padding:14px;margin-bottom:10px;display:none}
.leg-card.show{display:block}
.leg-lbl{font-family:'Space Mono';font-size:9px;color:#ffcc00;letter-spacing:2px;margin-bottom:8px}
.leg-txt{font-size:13px;line-height:1.85;color:#ddd;white-space:pre-wrap;word-break:break-word}

/* COPY BTN */
.cp{
  display:inline-flex;align-items:center;gap:5px;margin-top:10px;
  background:#1e1e1e;border:1px solid #2a2a2a;color:#666;
  padding:7px 12px;border-radius:8px;font-size:12px;cursor:pointer;
}
.cp:active{background:#2a2a2a}

/* ARTE FINAL BTN */
.btn-arte{
  display:none;width:100%;padding:17px;margin-bottom:12px;
  background:linear-gradient(135deg,#7c3aed,#a855f7);
  color:#fff;border:none;border-radius:14px;
  font-family:'Bebas Neue';font-size:22px;letter-spacing:3px;
  cursor:pointer;align-items:center;justify-content:center;gap:8px;
  transition:opacity .15s,transform .1s;
}
.btn-arte.show{display:flex}
.btn-arte:active{opacity:.85;transform:scale(.98)}
.btn-arte:disabled{background:#222;color:#444;cursor:not-allowed;transform:none}

/* MODAL */
.modal{
  position:fixed;inset:0;z-index:1000;
  background:rgba(0,0,0,.92);backdrop-filter:blur(10px);
  display:none;overflow-y:auto;-webkit-overflow-scrolling:touch;
  padding:14px 14px 60px;
}
.modal.open{display:block}
.modal-inner{
  background:#111;border:1px solid #2a2a2a;border-radius:18px;
  overflow:hidden;max-width:520px;margin:0 auto;
}
.modal-hd{
  padding:15px 16px;border-bottom:1px solid #2a2a2a;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;background:#111;z-index:10;
}
.modal-title{font-family:'Bebas Neue';font-size:20px;letter-spacing:2px}
.modal-title em{color:#a855f7;font-style:normal}
.modal-x{
  width:32px;height:32px;border-radius:9px;border:1px solid #2a2a2a;
  background:transparent;color:#666;font-size:18px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;
}
.modal-body{padding:16px;display:flex;flex-direction:column;gap:14px;align-items:center}

.step-log{
  width:100%;background:#1e1e1e;border-radius:10px;
  padding:10px 12px;display:flex;flex-direction:column;gap:4px;
}
.step-row{display:flex;align-items:center;gap:8px;font-family:'Space Mono';font-size:10px;color:#444}
.step-row.active{color:#ffcc00}
.step-row.ok{color:#22c55e}
.step-row.err{color:#ef4444}

.modal-msg{font-family:'Space Mono';font-size:11px;color:#555;text-align:center;width:100%}
.modal-msg.ok{color:#22c55e}
.modal-msg.err{color:#ef4444}

/* CARD PREVIEW */
.preview-outer{
  width:100%;border-radius:12px;overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,.8);position:relative;
}
.preview-ratio{width:100%;position:relative}
.preview-ratio-inner{position:absolute;inset:0;overflow:hidden}
.preview-spin{
  position:absolute;inset:0;background:rgba(0,0,0,.85);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:12px;z-index:5;border-radius:12px;
}
.preview-spin.gone{display:none}
.spin-ring{
  width:40px;height:40px;border-radius:50%;
  border:3px solid #333;border-top-color:#a855f7;
  animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.spin-txt{font-family:'Space Mono';font-size:10px;color:#a855f7;letter-spacing:1px;text-align:center}

.btn-dl{
  width:100%;padding:16px;
  background:linear-gradient(135deg,#6d28d9,#a855f7);
  color:#fff;border:none;border-radius:14px;
  font-family:'Bebas Neue';font-size:20px;letter-spacing:3px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
  transition:opacity .15s;
}
.btn-dl:active{opacity:.85}
.btn-dl:disabled{background:#222;color:#444;cursor:not-allowed}

/* TOAST */
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:#1e1e1e;border:1px solid #3a3a3a;
  color:#f0f0f0;padding:11px 20px;border-radius:20px;
  font-size:13px;z-index:9999;white-space:nowrap;
  animation:tin .2s ease;pointer-events:none;
}
@keyframes tin{from{opacity:0;transform:translate(-50%,8px)}to{opacity:1;transform:translate(-50%,0)}}

/* HIDDEN RENDER DIV */
#RT{
  position:fixed;left:-29999px;top:0;
  width:1080px;height:1080px;overflow:hidden;
  z-index:-1;pointer-events:none;
}
</style>
</head>
<body>

<div class="hdr">
  <div class="logo">SQU<span>AD</span></div>
  <div class="live-badge">GEMINI 2.0 FLASH</div>
</div>

<div class="page">

  <!-- API KEY -->
  <div class="box">
    <div class="box-lbl">// Gemini API Key</div>

    <!-- Shows when key is saved -->
    <div class="key-saved hidden" id="keySaved">
      <span class="ic">üîë</span>
      <span id="keyDisplay">Key configurada</span>
      <button class="btn-key-reset" onclick="resetKey()" style="margin-left:auto;margin-top:0">Trocar</button>
    </div>

    <!-- Shows when no key -->
    <div id="keyForm">
      <div class="key-form">
        <input class="key-inp" id="keyInp" type="password" placeholder="Cole sua chave (AIza...)"/>
        <button class="btn-key" onclick="salvarKey()">Salvar</button>
      </div>
      <div class="key-hint">
        Obtenha gr√°tis em <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a>
      </div>
    </div>
  </div>

  <!-- BRIEF -->
  <div class="box">
    <div class="box-lbl">// Brief Criativo</div>

    <div class="field">
      <label class="lbl">Marca / Cliente</label>
      <input class="inp" id="fBrand" type="text" placeholder="Ex: Studio Fit, Caf√© Noir..."/>
    </div>

    <div class="field">
      <label class="lbl">Nicho</label>
      <div class="sel-w">
        <select class="sel" id="fNiche">
          <option value="">Selecione o nicho...</option>
          <option>Moda e Lifestyle</option>
          <option>Food e Gastronomia</option>
          <option>Saude e Fitness</option>
          <option>Negocios e Empreendedorismo</option>
          <option>E-commerce e Produto</option>
          <option>Beleza e Estetica</option>
          <option>Tech e Startups</option>
          <option>Imoveis</option>
          <option>Educacao e Cursos</option>
          <option>Financas e Investimentos</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label class="lbl">Objetivo</label>
      <div class="sel-w">
        <select class="sel" id="fObj">
          <option value="">Selecione o objetivo...</option>
          <option>Engajamento maximo</option>
          <option>Conversao e Vendas</option>
          <option>Awareness e Branding</option>
          <option>Lancamento de produto</option>
          <option>Autoridade e Educacao</option>
          <option>Oferta e Promocao</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label class="lbl">Produto / Servi√ßo / Tema</label>
      <textarea class="ta" id="fDesc" placeholder="Descreva: o que √©, para quem, oferta, diferencial, pre√ßo..."></textarea>
    </div>

    <div class="field">
      <label class="lbl">Tom Visual</label>
      <div class="sel-w">
        <select class="sel" id="fTone">
          <option value="">Selecione o tom...</option>
          <option>Premium e Luxo</option>
          <option>Moderno e Bold</option>
          <option>Inspirador e Emocional</option>
          <option>Divertido e Jovem</option>
          <option>Clean e Organico</option>
          <option>Dark e Cinematografico</option>
          <option>Corporativo e Profissional</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label class="lbl">P√∫blico-Alvo (opcional)</label>
      <input class="inp" id="fAud" type="text" placeholder="Ex: Mulheres 28-42, classe B..."/>
    </div>
  </div>

  <!-- FORMAT -->
  <div class="box">
    <div class="box-lbl">// Formato do Card</div>
    <div class="fmt-row">
      <div class="fmt-btn on" id="fmt0" onclick="setFmt(0,1080,1080,'Feed 1:1')">
        <div class="fmt-thumb" style="width:32px;height:32px"></div>
        <div class="fmt-nm">FEED</div>
        <div class="fmt-sz">1080√ó1080</div>
      </div>
      <div class="fmt-btn" id="fmt1" onclick="setFmt(1,1080,1350,'Portrait 4:5')">
        <div class="fmt-thumb" style="width:24px;height:32px"></div>
        <div class="fmt-nm">PORTRAIT</div>
        <div class="fmt-sz">1080√ó1350</div>
      </div>
      <div class="fmt-btn" id="fmt2" onclick="setFmt(2,1080,1920,'Stories 9:16')">
        <div class="fmt-thumb" style="width:16px;height:32px"></div>
        <div class="fmt-nm">STORIES</div>
        <div class="fmt-sz">1080√ó1920</div>
      </div>
    </div>
  </div>

  <!-- LAUNCH -->
  <button class="btn-go" id="btnGo" onclick="iniciar()">‚ñ∂ ACIONAR SQUAD</button>

  <!-- PROGRESS -->
  <div class="prog" id="progBox">
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-meta"><span id="progLbl">Iniciando...</span><span id="progPct">0%</span></div>
  </div>

  <!-- AGENTS -->
  <div id="agents"></div>

  <!-- PROMPT -->
  <div class="prompt-card" id="promptCard">
    <div class="prompt-lbl">PROMPT GERADO ‚Äî MIDJOURNEY / POLLINATIONS AI</div>
    <div class="prompt-txt" id="promptTxt"></div>
    <button class="cp" onclick="copiar('promptTxt',this)">‚éò Copiar prompt</button>
  </div>

  <!-- LEGENDA -->
  <div class="leg-card" id="legCard">
    <div class="leg-lbl">LEGENDA INSTAGRAM</div>
    <div class="leg-txt" id="legTxt"></div>
    <button class="cp" onclick="copiar('legTxt',this)">‚éò Copiar legenda</button>
  </div>

  <!-- EXTRA OUTPUTS -->
  <div id="extraOut"></div>

  <!-- ARTE FINAL -->
  <button class="btn-arte" id="btnArte" onclick="abrirModal()">üé® GERAR ARTE FINAL</button>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-inner">
    <div class="modal-hd">
      <div class="modal-title">ARTE <em>FINAL</em></div>
      <button class="modal-x" onclick="fecharModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="step-log" id="stepLog"></div>
      <div class="modal-msg" id="modalMsg">Iniciando gera√ß√£o...</div>
      <div class="preview-outer" id="prevOuter">
        <div class="preview-spin" id="prevSpin">
          <div class="spin-ring"></div>
          <div class="spin-txt" id="spinTxt">GERANDO IMAGEM...</div>
        </div>
        <div class="preview-ratio" id="prevRatio">
          <div class="preview-ratio-inner" id="prevInner"></div>
        </div>
      </div>
      <button class="btn-dl" id="btnDl" onclick="baixar()" disabled>‚¨á BAIXAR PNG</button>
    </div>
  </div>
</div>

<!-- FULL-RES RENDER TARGET -->
<div id="RT"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALL CODE IN GLOBAL SCOPE ‚Äî NO IIFE
// Variables accessible everywhere
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var GEMINI_KEY = '';
var BRIEF = {};
var OUTS = [];
var FMT = { w:1080, h:1080, label:'Feed 1:1' };
var RUNNING = false;
var MJ_PROMPT = '';
var MODAL_STEPS = [];

// ‚îÄ‚îÄ INIT: load key from localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function init() {
  var saved = '';
  try { saved = localStorage.getItem('squad_gemini_key') || ''; } catch(e) {}
  if (saved) {
    GEMINI_KEY = saved;
    showKeySaved(saved);
  }
})();

function showKeySaved(key) {
  document.getElementById('keySaved').classList.remove('hidden');
  document.getElementById('keyForm').style.display = 'none';
  document.getElementById('keyDisplay').textContent = 'Key ativa: ' + key.substring(0,12) + '...';
}

function showKeyForm() {
  document.getElementById('keySaved').classList.add('hidden');
  document.getElementById('keyForm').style.display = 'block';
}

// ‚îÄ‚îÄ KEY FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function salvarKey() {
  var inp = document.getElementById('keyInp');
  var val = inp.value.trim();

  if (!val) {
    inp.classList.add('error');
    setTimeout(function(){ inp.classList.remove('error'); }, 1000);
    toast('‚ö†Ô∏è Cole a API Key!');
    return;
  }

  // Accept any non-empty key (don't validate prefix ‚Äî some keys differ)
  GEMINI_KEY = val;

  try { localStorage.setItem('squad_gemini_key', val); } catch(e) {}

  inp.value = '';
  showKeySaved(val);
  toast('‚úì Key salva e persistida!');
}

function resetKey() {
  GEMINI_KEY = '';
  try { localStorage.removeItem('squad_gemini_key'); } catch(e) {}
  showKeyForm();
  toast('Key removida.');
}

// ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setFmt(i, w, h, label) {
  [0,1,2].forEach(function(x){ document.getElementById('fmt'+x).classList.remove('on'); });
  document.getElementById('fmt'+i).classList.add('on');
  FMT = { w:w, h:h, label:label };
}

// ‚îÄ‚îÄ AGENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var AGENTS = [
  {
    ico:'üß†', name:'ESTRATEGISTA',
    role:'Insight, conceito e arquitetura do post',
    getPrompt: function() {
      return 'Voc√™ √© Estrategista de Conte√∫do S√™nior especializado em Instagram e marketing digital.\n'
        + 'Responda em portugu√™s. Use **negrito** nos t√≠tulos.\n\n'
        + 'BRIEF:\nMarca: ' + BRIEF.brand + '\nNicho: ' + BRIEF.niche
        + '\nObjetivo: ' + BRIEF.obj + '\nProduto/Tema: ' + BRIEF.desc
        + '\nTom: ' + BRIEF.tone + '\nFormato: ' + FMT.label + ' (' + FMT.w + 'x' + FMT.h + 'px)\n\n'
        + '**DIAGN√ìSTICO DO P√öBLICO**\nQuem √©, qual dor, o que deseja, como age no Instagram.\n\n'
        + '**INSIGHT ESTRAT√âGICO**\nA descoberta n√£o-√≥bvia que fundamenta este post.\n\n'
        + '**√ÇNGULO CRIATIVO**\nPor que este √¢ngulo vai funcionar.\n\n'
        + '**GANCHO CENTRAL**\nA frase que para o scroll.\n\n'
        + '**ELEMENTOS DO CARD**\nBadge, t√≠tulo principal, subt√≠tulo, CTA.\n\n'
        + '**KPIs DE SUCESSO**\nM√©tricas que indicam sucesso.';
    }
  },
  {
    ico:'‚úçÔ∏è', name:'COPYWRITER',
    role:'Textos definitivos que entram no card visual',
    getPrompt: function() {
      return 'Voc√™ √© Copywriter S√™nior de resposta direta para Instagram.\n'
        + 'O texto do card tem 0,3-2 segundos para funcionar. Cada palavra conta.\n'
        + 'Responda em portugu√™s.\n\n'
        + 'ESTRAT√âGIA:\n' + (OUTS[0]||'sem dados').substring(0,500) + '\n\n'
        + 'Marca: ' + BRIEF.brand + ' | Tom: ' + BRIEF.tone + '\n\n'
        + 'ENTREGUE NESTE FORMATO EXATO:\n\n'
        + '**BADGE**\n[2-3 palavras MAI√öSCULO ou vazio]\n\n'
        + '**EYEBROW**\n[linha acima do headline, m√°x 5 palavras]\n\n'
        + '**HEADLINE**\n[MAI√öSCULO, m√°x 5 palavras]\n\n'
        + '**SUBTEXT**\n[complemento, m√°x 12 palavras]\n\n'
        + '**CTA**\n[chamada √† a√ß√£o, m√°x 4 palavras]\n\n'
        + '**JUSTIFICATIVA**\n[por que estas escolhas funcionam]';
    }
  },
  {
    ico:'üì∏', name:'DIR. FOTOGRAFIA',
    role:'Prompt para gera√ß√£o de imagem por IA',
    getPrompt: function() {
      return 'Voc√™ √© Diretor de Fotografia especializado em prompts para IA generativa.\n'
        + 'Imagem de fundo: impacto visual, √°rea inferior limpa para texto.\n'
        + 'Responda em portugu√™s. O PROMPT DE IMAGEM em ingl√™s.\n\n'
        + 'Nicho: ' + BRIEF.niche + ' | Tom: ' + BRIEF.tone
        + ' | Formato: ' + FMT.w + 'x' + FMT.h + '\n'
        + 'Copy: ' + (OUTS[1]||'sem dados').substring(0,200) + '\n\n'
        + '**CONCEITO DA IMAGEM**\nO que vai mostrar e por que √© poderoso.\n\n'
        + '**ESTILO**\nFotografia real, CGI, abstrato?\n\n'
        + '**PROMPT DE IMAGEM**\n'
        + '[Prompt em ingl√™s: sujeito, ambiente, ilumina√ß√£o, mood. '
        + 'Finalizar com: 8k, cinematic, professional photography, no text, no watermark]\n\n'
        + '**CORES**\nPaleta e tratamento.';
    }
  },
  {
    ico:'üé®', name:'DIR. DE ARTE',
    role:'Paleta HEX, fontes e sistema visual',
    getPrompt: function() {
      return 'Voc√™ √© Diretor de Arte S√™nior para Instagram. Retorna CARD_JSON com HEX exatos.\nResponda em portugu√™s.\n\n'
        + 'Nicho: ' + BRIEF.niche + ' | Tom: ' + BRIEF.tone
        + ' | Formato: ' + FMT.w + 'x' + FMT.h + '\n'
        + 'Copy: ' + (OUTS[1]||'sem dados').substring(0,300) + '\n\n'
        + '**CONCEITO VISUAL**\n**PALETA** (HEX obrigat√≥rio)\n**TIPOGRAFIA** (Google Fonts)\n\n'
        + 'RETORNE O JSON ABAIXO (substitua todos os valores com HEX reais):\n'
        + 'CARD_JSON_START\n'
        + '{"bg1":"#0a0a0a","bg2":"#1a1a2e","overlay":"rgba(0,0,0,0.65)",'
        + '"hlColor":"#FFFFFF","hlFont":"Bebas Neue","hlSize":' + (FMT.h>1500?110:FMT.h>1100?88:72) + ','
        + '"eyColor":"#FFCC00","stColor":"rgba(255,255,255,0.8)",'
        + '"badgeBg":"#FF3C00","badgeFg":"#FFFFFF","ctaColor":"#FFFFFF",'
        + '"acc1":"#FF3C00","acc2":"#FFCC00","decor":"rgba(255,255,255,0.04)"}\n'
        + 'CARD_JSON_END';
    }
  },
  {
    ico:'üí¨', name:'COPY LEGENDA',
    role:'Legenda poderosa + hashtags estrat√©gicas',
    getPrompt: function() {
      return 'Voc√™ √© especialista em Copy para Instagram. Legenda que gera engajamento real.\nResponda em portugu√™s.\n\n'
        + 'Marca: ' + BRIEF.brand + ' | Objetivo: ' + BRIEF.obj + ' | Tom: ' + BRIEF.tone + '\n'
        + 'Card: ' + (OUTS[1]||'sem dados').substring(0,200) + '\n\n'
        + '**HOOK** (antes do "ver mais" ‚Äî m√°x 125 chars)\n[Provocador ou promessa forte]\n\n'
        + '**CORPO**\n[4-5 par√°grafos com emojis. Storytelling ou benef√≠cios.]\n\n'
        + '**CTA PRINCIPAL**\n**CTA SECUND√ÅRIO**\n\n'
        + '**HASHTAGS**\n[25: 5 mega + 8 grandes + 8 m√©dias + 4 nicho]\n\n'
        + '**MELHOR HOR√ÅRIO**\n[Dia + hora + justificativa]';
    }
  },
  {
    ico:'üìä', name:'TR√ÅFEGO PAGO',
    role:'Meta Ads: segmenta√ß√£o e estrat√©gia de m√≠dia',
    getPrompt: function() {
      return 'Voc√™ √© Especialista em Meta Ads com 10 anos de experi√™ncia.\nResponda em portugu√™s.\n\n'
        + 'Objetivo: ' + BRIEF.obj + ' | Nicho: ' + BRIEF.niche + ' | Formato: ' + FMT.label + '\n\n'
        + '**COPY PARA AN√öNCIO**\nTexto (m√°x 125): | Headline (m√°x 40): | Descri√ß√£o (m√°x 30):\n\n'
        + '**OBJETIVO META ADS**\n**SEGMENTA√á√ÉO**\n**ESTRUTURA**\n**TESTE A/B**\n\n'
        + '**M√âTRICAS ESPERADAS**\nCTR: | CPM: | CPC: | ROAS m√≠nimo:';
    }
  },
  {
    ico:'üèÜ', name:'DIR. CRIATIVO',
    role:'Revis√£o final e checklist de publica√ß√£o',
    getPrompt: function() {
      return 'Voc√™ √© Diretor Criativo Executivo. Revis√£o cir√∫rgica e honesta.\nResponda em portugu√™s.\n\n'
        + 'Marca: ' + BRIEF.brand + ' | Objetivo: ' + BRIEF.obj + '\n'
        + 'Copy: ' + (OUTS[1]||'').substring(0,150) + '\n'
        + 'Legenda: ' + (OUTS[4]||'').substring(0,150) + '\n\n'
        + '**AVALIA√á√ÉO** (0-10)\nEstrat√©gia: | Copy: | Arte: | Foto: | Legenda: | Tr√°fego:\n\n'
        + '**PONTOS FORTES**\n**AJUSTES CR√çTICOS** (m√°x 3)\n\n'
        + '**CHECKLIST**\n- [ ] Ortografia\n- [ ] Links\n- [ ] Resolu√ß√£o\n- [ ] CTA\n'
        + '- [ ] Hashtags\n- [ ] Hor√°rio\n- [ ] Pixel e UTMs\n\n'
        + '**SCORE FINAL**\nNota: /10 | Probabilidade acima da m√©dia: %\nVeredicto:';
    }
  }
];

// ‚îÄ‚îÄ BUILD AGENTS UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildAgents() {
  var html = '';
  AGENTS.forEach(function(ag, i) {
    html += '<div class="agent" id="ag'+i+'">'
      + '<div class="agent-hd" onclick="toggleAg('+i+')">'
      +   '<div class="agent-ico">'+ag.ico+'</div>'
      +   '<div class="agent-info">'
      +     '<div class="agent-num">AGENTE 0'+(i+1)+'</div>'
      +     '<div class="agent-name">'+ag.name+'</div>'
      +     '<div class="agent-role">'+ag.role+'</div>'
      +   '</div>'
      +   '<div class="agent-tag" id="atag'+i+'">IDLE</div>'
      + '</div>'
      + '<div class="agent-body" id="abody'+i+'">'
      +   '<div class="agent-body-txt" id="atxt'+i+'"></div>'
      + '</div>'
      + '</div>';
  });
  document.getElementById('agents').innerHTML = html;
}
buildAgents();

function toggleAg(i) {
  document.getElementById('abody'+i).classList.toggle('open');
}

// ‚îÄ‚îÄ GEMINI CALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function chamarGemini(prompt, onDone) {
  // onDone(error, result)
  if (!GEMINI_KEY) {
    onDone('API Key n√£o configurada!', null);
    return;
  }

  var endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + GEMINI_KEY;

  var requestBody = {
    contents: [{
      role: 'user',
      parts: [{ text: prompt }]
    }],
    generationConfig: {
      maxOutputTokens: 1200,
      temperature: 0.85
    }
  };

  var xhr = new XMLHttpRequest();
  xhr.open('POST', endpoint, true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.timeout = 90000;

  xhr.onload = function() {
    if (xhr.status === 0) {
      onDone('Sem resposta ‚Äî verifique sua conex√£o.', null);
      return;
    }

    var parsed;
    try {
      parsed = JSON.parse(xhr.responseText);
    } catch(e) {
      onDone('Resposta inv√°lida da API (status ' + xhr.status + ').', null);
      return;
    }

    // API error
    if (parsed.error) {
      var msg = parsed.error.message || JSON.stringify(parsed.error);
      onDone('Gemini: ' + msg, null);
      return;
    }

    // Extract text
    var txt = '';
    try {
      txt = parsed.candidates[0].content.parts[0].text;
    } catch(e) {
      // Check for safety block
      if (parsed.candidates && parsed.candidates[0] && parsed.candidates[0].finishReason) {
        onDone('Bloqueado: ' + parsed.candidates[0].finishReason, null);
      } else {
        onDone('Resposta vazia ou inesperada.', null);
      }
      return;
    }

    onDone(null, txt);
  };

  xhr.onerror = function() {
    onDone('Erro de rede. Verifique sua conex√£o.', null);
  };

  xhr.ontimeout = function() {
    onDone('Timeout (90s). Tente novamente.', null);
  };

  xhr.send(JSON.stringify(requestBody));
}

// ‚îÄ‚îÄ MAIN LAUNCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function iniciar() {
  if (RUNNING) return;

  if (!GEMINI_KEY) {
    toast('‚ö†Ô∏è Configure a API Key primeiro!');
    document.getElementById('keyInp').focus();
    return;
  }

  var desc = (document.getElementById('fDesc').value || '').trim();
  if (!desc) {
    toast('‚ö†Ô∏è Descreva o produto ou servi√ßo!');
    document.getElementById('fDesc').focus();
    return;
  }

  BRIEF = {
    brand: (document.getElementById('fBrand').value || '').trim() || 'Marca',
    niche: document.getElementById('fNiche').value || 'geral',
    obj:   document.getElementById('fObj').value || 'engajamento',
    desc:  desc,
    tone:  document.getElementById('fTone').value || 'moderno',
    aud:   (document.getElementById('fAud').value || '').trim()
  };

  RUNNING = true;
  OUTS = [];
  MJ_PROMPT = '';

  // Reset UI
  AGENTS.forEach(function(_, i) {
    var el = document.getElementById('ag'+i);
    el.classList.remove('running','done','error');
    document.getElementById('atag'+i).textContent = 'IDLE';
    document.getElementById('abody'+i).classList.remove('open');
    document.getElementById('atxt'+i).innerHTML = '';
  });
  document.getElementById('promptCard').classList.remove('show');
  document.getElementById('legCard').classList.remove('show');
  document.getElementById('extraOut').innerHTML = '';
  document.getElementById('btnArte').classList.remove('show');
  document.getElementById('RT').innerHTML = '';

  var btn = document.getElementById('btnGo');
  btn.disabled = true;
  btn.textContent = '‚è≥ SQUAD EM A√á√ÉO...';

  document.getElementById('progBox').classList.add('show');
  setProgress(0);

  rodar(0);
}

function rodar(i) {
  if (i >= AGENTS.length) {
    setProgress(AGENTS.length);
    document.getElementById('btnGo').disabled = false;
    document.getElementById('btnGo').textContent = '‚ñ∂ ACIONAR SQUAD';
    RUNNING = false;
    document.getElementById('btnArte').classList.add('show');
    toast('‚úì Squad conclu√≠do! Gere a arte final abaixo.');
    setTimeout(function() {
      document.getElementById('btnArte').scrollIntoView({ behavior:'smooth', block:'center' });
    }, 400);
    return;
  }

  setProgress(i);

  // Mark running
  var agEl = document.getElementById('ag'+i);
  agEl.classList.remove('done','error');
  agEl.classList.add('running');
  document.getElementById('atag'+i).textContent = 'RUN';
  document.getElementById('abody'+i).classList.add('open');
  document.getElementById('atxt'+i).innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
  agEl.scrollIntoView({ behavior:'smooth', block:'nearest' });

  var prompt = AGENTS[i].getPrompt();

  chamarGemini(prompt, function(err, result) {
    agEl.classList.remove('running');

    if (err) {
      OUTS.push('');
      agEl.classList.add('error');
      document.getElementById('atag'+i).textContent = 'ERR';
      document.getElementById('atxt'+i).innerHTML =
        '<div class="err-msg">‚ö†Ô∏è ' + escHtml(err) + '\n\n'
        + 'Verifique:\n‚Ä¢ API Key correta?\n‚Ä¢ Conex√£o ativa?\n‚Ä¢ Limite do plano gratuito atingido?</div>';
    } else {
      OUTS.push(result);
      agEl.classList.add('done');
      document.getElementById('atag'+i).textContent = '‚úì';
      document.getElementById('atxt'+i).innerHTML = renderMd(result.substring(0, 500) + (result.length > 500 ? '‚Ä¶' : ''));
      processar(i, result);
    }

    setTimeout(function() { rodar(i + 1); }, 300);
  });
}

function processar(i, text) {
  // Agente 2 = fot√≥grafo
  if (i === 2) {
    var m = text.match(/\*\*PROMPT DE IMAGEM\*\*\n([\s\S]+?)(?:\n\n\*\*|$)/i);
    MJ_PROMPT = m ? m[1].trim().replace(/^```\w*\n?/,'').replace(/```$/,'').trim() : '';
    if (!MJ_PROMPT) MJ_PROMPT = BRIEF.niche + ' professional atmosphere, cinematic, 8k, no text';
    document.getElementById('promptTxt').textContent = MJ_PROMPT;
    document.getElementById('promptCard').classList.add('show');
  }

  // Agente 4 = legenda
  if (i === 4) {
    document.getElementById('legTxt').textContent = text.replace(/\*\*/g,'');
    document.getElementById('legCard').classList.add('show');

    var out = document.getElementById('extraOut');
    out.innerHTML = [
      {t:'üé® DIRE√á√ÉO DE ARTE',    idx:3},
      {t:'üì∏ DIR. FOTOGRAFIA',    idx:2},
      {t:'‚úçÔ∏è COPY DO CARD',       idx:1},
      {t:'üß† ESTRAT√âGIA',         idx:0}
    ].map(function(d) {
      return '<div class="out-box">'
        + '<div class="out-hd" onclick="toggleOut(\'oo'+d.idx+'\')">'
        +   '<div class="out-title">'+d.t+'</div>'
        +   '<span style="color:#444">‚ñæ</span>'
        + '</div>'
        + '<div class="out-body" id="oo'+d.idx+'">'+renderMd(OUTS[d.idx]||'')+'</div>'
        + '</div>';
    }).join('');
  }

  if (i === 5) {
    document.getElementById('extraOut').innerHTML +=
      '<div class="out-box">'
      + '<div class="out-hd" onclick="toggleOut(\'ooT\')">'
      +   '<div class="out-title">üìä TR√ÅFEGO PAGO</div><span style="color:#444">‚ñæ</span>'
      + '</div>'
      + '<div class="out-body" id="ooT">'+renderMd(text)+'</div>'
      + '</div>';
  }

  if (i === 6) {
    document.getElementById('extraOut').innerHTML +=
      '<div class="out-box" style="border-color:rgba(255,204,0,.3)">'
      + '<div class="out-hd" onclick="toggleOut(\'ooDC\')">'
      +   '<div class="out-title">üèÜ REVIS√ÉO FINAL ‚Äî DIR. CRIATIVO</div><span style="color:#444">‚ñæ</span>'
      + '</div>'
      + '<div class="out-body open" id="ooDC">'+renderMd(text)+'</div>'
      + '</div>';
  }
}

function setProgress(cur) {
  var pct = Math.round(cur / AGENTS.length * 100);
  document.getElementById('progFill').style.width = pct + '%';
  document.getElementById('progPct').textContent = pct + '%';
  document.getElementById('progLbl').textContent = cur < AGENTS.length
    ? 'Agente ' + (cur+1) + ': ' + AGENTS[cur].name
    : '‚úì Pipeline conclu√≠do!';
}

// ‚îÄ‚îÄ ARTE FINAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirModal() {
  var modal = document.getElementById('modal');
  modal.classList.add('open');
  modal.scrollTop = 0;

  // Reset
  document.getElementById('prevSpin').classList.remove('gone');
  document.getElementById('spinTxt').textContent = 'GERANDO IMAGEM...';
  document.getElementById('modalMsg').className = 'modal-msg';
  document.getElementById('modalMsg').textContent = 'Gerando imagem com Pollinations AI...';
  document.getElementById('btnDl').disabled = true;
  document.getElementById('stepLog').innerHTML = '';
  document.getElementById('prevInner').innerHTML = '';
  document.getElementById('btnArte').disabled = true;

  // Set ratio
  document.getElementById('prevRatio').style.paddingTop = (FMT.h / FMT.w * 100) + '%';

  // Resize RT
  var rt = document.getElementById('RT');
  rt.style.width  = FMT.w + 'px';
  rt.style.height = FMT.h + 'px';

  MODAL_STEPS = [];
  gerarArte();
}

function addModalStep(txt) {
  if (MODAL_STEPS.length > 0) MODAL_STEPS[MODAL_STEPS.length-1].done = true;
  MODAL_STEPS.push({ txt:txt, done:false, err:false });
  renderModalSteps();
  document.getElementById('spinTxt').textContent = txt.substring(0,22).toUpperCase();
}

function renderModalSteps() {
  document.getElementById('stepLog').innerHTML = MODAL_STEPS.map(function(s) {
    var cls = s.done ? 'ok' : s.err ? 'err' : 'active';
    var ic  = s.done ? '‚úì' : s.err ? '‚úï' : '‚óè';
    return '<div class="step-row '+cls+'">'+ic+' '+escHtml(s.txt)+'</div>';
  }).join('');
}

function gerarArte() {
  addModalStep('Gerando imagem com Pollinations AI...');

  var seed = Math.floor(Math.random() * 99999);
  var enc  = encodeURIComponent(MJ_PROMPT.substring(0, 350));
  var url  = 'https://image.pollinations.ai/prompt/' + enc
    + '?width=' + FMT.w + '&height=' + FMT.h
    + '&seed=' + seed + '&model=flux&nologo=true&enhance=true';

  var imgEl = new Image();
  imgEl.crossOrigin = 'anonymous';

  var timer = setTimeout(function() {
    addModalStep('Timeout ‚Äî usando gradiente de fundo...');
    buildCard(null);
  }, 22000);

  imgEl.onload = function() {
    clearTimeout(timer);
    addModalStep('Imagem carregada! Montando card...');
    buildCard(imgEl);
  };

  imgEl.onerror = function() {
    clearTimeout(timer);
    addModalStep('Imagem indispon√≠vel ‚Äî usando gradiente...');
    buildCard(null);
  };

  imgEl.src = url;
}

function buildCard(imgEl) {
  // Parse art direction
  var cs = {};
  var sm = (OUTS[3]||'').match(/CARD_JSON_START\s*([\s\S]*?)\s*CARD_JSON_END/);
  if (sm) { try { cs = JSON.parse(sm[1].trim()); } catch(e){} }

  var C = {
    bg1:     cs.bg1     || '#0a0a0a',
    bg2:     cs.bg2     || '#1a1a2e',
    overlay: cs.overlay || 'rgba(0,0,0,0.65)',
    hlColor: cs.hlColor || '#FFFFFF',
    hlFont:  cs.hlFont  || 'Bebas Neue',
    hlSize:  parseInt(cs.hlSize)  || (FMT.h>1500?110:FMT.h>1100?88:72),
    eyColor: cs.eyColor || '#FFCC00',
    stColor: cs.stColor || 'rgba(255,255,255,0.80)',
    badgeBg: cs.badgeBg || '#FF3C00',
    badgeFg: cs.badgeFg || '#FFFFFF',
    ctaColor:cs.ctaColor|| '#FFFFFF',
    acc1:    cs.acc1    || '#FF3C00',
    acc2:    cs.acc2    || '#FFCC00',
    decor:   cs.decor   || 'rgba(255,255,255,0.04)'
  };

  function gField(label) {
    var rx = new RegExp('\\*\\*' + label + '\\*\\*\\n([^\\n\\*]+)', 'i');
    var m  = (OUTS[1]||'').match(rx);
    return m ? m[1].trim().replace(/^\[|\]$/g,'') : '';
  }

  var badge    = gField('BADGE');
  var eyebrow  = gField('EYEBROW');
  var headline = gField('HEADLINE') || BRIEF.brand.toUpperCase();
  var subtext  = gField('SUBTEXT');
  var cta      = gField('CTA');
  var brand    = '@' + BRIEF.brand.toLowerCase().replace(/\s+/g,'');

  var W = FMT.w, H = FMT.h, pad = Math.round(W*.065), hl = C.hlSize;

  function mk(tag, css, txt) {
    var d = document.createElement(tag);
    d.style.cssText = css;
    if (txt !== undefined) d.textContent = txt;
    return d;
  }

  // Build background CSS
  var bgCss;
  if (imgEl) {
    var cv = document.createElement('canvas');
    cv.width = W; cv.height = H;
    var ctx = cv.getContext('2d');
    var iR = imgEl.naturalWidth / imgEl.naturalHeight;
    var cR = W / H;
    var dw, dh, dx, dy;
    if (iR > cR) { dh=H; dw=H*iR; dx=(W-dw)/2; dy=0; }
    else          { dw=W; dh=W/iR; dx=0; dy=(H-dh)/2; }
    ctx.drawImage(imgEl, dx, dy, dw, dh);
    bgCss = 'background-image:url('+cv.toDataURL('image/jpeg',.9)+');background-size:cover;';
  } else {
    bgCss = 'background:linear-gradient(160deg,'+C.bg1+' 0%,'+C.bg2+' 100%);';
  }

  var card = mk('div', 'position:relative;width:'+W+'px;height:'+H+'px;overflow:hidden;'+bgCss);

  // Overlay
  card.appendChild(mk('div','position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.92) 0%,rgba(0,0,0,.4) 55%,rgba(0,0,0,.08) 100%);'));

  // SVG decor
  var svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 '+W+' '+H);
  svg.style.cssText='position:absolute;inset:0;width:100%;height:100%;pointer-events:none;';
  function circ(cx,cy,r){
    var c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',cx);c.setAttribute('cy',cy);c.setAttribute('r',r);c.setAttribute('fill',C.decor);
    return c;
  }
  svg.appendChild(circ(Math.round(W*.84),Math.round(H*.11),Math.round(W*.18)));
  svg.appendChild(circ(Math.round(W*.08),Math.round(H*.4),Math.round(W*.09)));
  card.appendChild(svg);

  // Badge
  if (badge) {
    var bsz = Math.round(hl*.16);
    card.appendChild(mk('div',
      'position:absolute;top:'+pad+'px;left:'+pad+'px;z-index:10;'
      +'background:'+C.badgeBg+';color:'+C.badgeFg+';'
      +'font-family:Space Mono,monospace;font-size:'+bsz+'px;letter-spacing:3px;'
      +'padding:'+Math.round(bsz*.5)+'px '+Math.round(bsz*1.1)+'px;'
      +'border-radius:4px;text-transform:uppercase;',
      badge));
  }

  // Brand tag
  card.appendChild(mk('div',
    'position:absolute;top:'+pad+'px;right:'+pad+'px;z-index:10;'
    +'font-family:Space Mono,monospace;font-size:'+Math.round(hl*.13)+'px;'
    +'color:rgba(255,255,255,.3);letter-spacing:2px;',
    brand));

  // Content bottom
  var cont = mk('div','position:absolute;bottom:'+Math.round(pad*1.4)+'px;left:'+pad+'px;right:'+pad+'px;z-index:10;');

  if (eyebrow) cont.appendChild(mk('div',
    'font-family:Space Mono,monospace;font-size:'+Math.round(hl*.19)+'px;'
    +'color:'+C.eyColor+';letter-spacing:4px;text-transform:uppercase;'
    +'margin-bottom:'+Math.round(hl*.12)+'px;',eyebrow));

  cont.appendChild(mk('div',
    'font-family:'+C.hlFont+',Impact,sans-serif;font-weight:700;font-size:'+hl+'px;'
    +'color:'+C.hlColor+';line-height:1.0;text-transform:uppercase;letter-spacing:1px;'
    +'margin-bottom:'+Math.round(hl*.14)+'px;text-shadow:0 2px 30px rgba(0,0,0,.7);',headline));

  if (subtext) cont.appendChild(mk('div',
    'font-family:Inter,sans-serif;font-size:'+Math.round(hl*.21)+'px;'
    +'color:'+C.stColor+';line-height:1.45;margin-bottom:'+Math.round(hl*.22)+'px;',subtext));

  if (cta) {
    var csz=Math.round(hl*.17);
    cont.appendChild(mk('div',
      'display:inline-block;font-family:Space Mono,monospace;font-size:'+csz+'px;'
      +'color:'+C.ctaColor+';border:1px solid rgba(255,255,255,.4);'
      +'padding:'+Math.round(csz*.6)+'px '+Math.round(csz*1.4)+'px;'
      +'letter-spacing:2px;text-transform:uppercase;border-radius:3px;',cta));
  }

  card.appendChild(cont);
  card.appendChild(mk('div','position:absolute;bottom:0;left:0;right:0;height:4px;background:linear-gradient(90deg,'+C.acc1+','+C.acc2+');'));

  // Insert full-size into RT
  var rt = document.getElementById('RT');
  rt.innerHTML = '';
  rt.appendChild(card);

  // Show scaled preview
  setTimeout(function() {
    var wW = document.getElementById('prevOuter').offsetWidth;
    var sc = wW / W;
    var inner = document.getElementById('prevInner');
    inner.innerHTML = '';
    var wrap = mk('div','position:absolute;top:0;left:0;width:'+W+'px;height:'+H+'px;transform:scale('+sc+');transform-origin:top left;');
    wrap.appendChild(card.cloneNode(true));
    inner.appendChild(wrap);

    document.getElementById('prevSpin').classList.add('gone');
    if (MODAL_STEPS.length>0) MODAL_STEPS[MODAL_STEPS.length-1].done=true;
    renderModalSteps();
    document.getElementById('modalMsg').className = 'modal-msg ok';
    document.getElementById('modalMsg').textContent = '‚úì Arte final pronta! Verifique e baixe.';
    document.getElementById('btnDl').disabled = false;
    document.getElementById('btnArte').disabled = false;
  }, 700);
}

// ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function baixar() {
  var btn = document.getElementById('btnDl');
  btn.disabled = true;
  btn.textContent = '‚è≥ CAPTURANDO...';

  var rt = document.getElementById('RT');
  var cardEl = rt.firstElementChild;

  if (!cardEl) {
    toast('‚ö†Ô∏è Gere a arte primeiro!');
    btn.disabled = false; btn.textContent = '‚¨á BAIXAR PNG';
    return;
  }

  // Bring on-screen briefly
  rt.style.left = '0';
  rt.style.zIndex = '9999';

  setTimeout(function() {
    html2canvas(cardEl, {
      width: FMT.w, height: FMT.h, scale: 1,
      useCORS: true, allowTaint: true,
      backgroundColor: null, logging: false
    }).then(function(canvas) {
      rt.style.left = '-29999px';
      rt.style.zIndex = '-1';

      canvas.toBlob(function(blob) {
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = BRIEF.brand.replace(/\s+/g,'-').toLowerCase() + '-' + FMT.w + 'x' + FMT.h + '.png';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(function(){ URL.revokeObjectURL(url); }, 3000);
        btn.textContent = '‚úì BAIXADO!';
        toast('‚úì PNG salvo no seu dispositivo!');
        setTimeout(function(){ btn.disabled=false; btn.textContent='‚¨á BAIXAR PNG'; }, 3000);
      }, 'image/png', 1.0);

    }).catch(function() {
      rt.style.left = '-29999px';
      rt.style.zIndex = '-1';
      // HTML fallback
      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">'
        + '<style>*{margin:0;padding:0}body{width:'+FMT.w+'px;height:'+FMT.h+'px;overflow:hidden}</style>'
        + '</head><body>' + rt.innerHTML + '</body></html>';
      var b = new Blob([html],{type:'text/html'});
      var u = URL.createObjectURL(b);
      var a = document.createElement('a');
      a.href=u; a.download=BRIEF.brand.replace(/\s+/g,'-').toLowerCase()+'.html';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(u);
      btn.disabled=false; btn.textContent='‚¨á BAIXAR PNG';
      toast('Salvo como HTML ‚Äî abra no Chrome para screenshot');
    });
  }, 500);
}

function fecharModal() {
  document.getElementById('modal').classList.remove('open');
  document.getElementById('btnArte').disabled = false;
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAg(i) {
  document.getElementById('abody'+i).classList.toggle('open');
}
function toggleOut(id) {
  document.getElementById(id).classList.toggle('open');
}
function copiar(id, btn) {
  var txt = document.getElementById(id).textContent;
  var orig = btn.textContent;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt).then(function(){ btn.textContent='‚úì Copiado!'; setTimeout(function(){ btn.textContent=orig; },2000); });
  } else {
    var ta=document.createElement('textarea');ta.value=txt;
    document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
    btn.textContent='‚úì Copiado!'; setTimeout(function(){ btn.textContent=orig; },2000);
  }
}
function renderMd(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
}
function escHtml(t) {
  return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function toast(msg) {
  var t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(function(){ if(t.parentNode)t.parentNode.removeChild(t); },2800);
}
</script>
</body>
</html>
